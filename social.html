<!DOCTYPE html>
<html lang="es">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Fenix Social - Conecta con la Comunidad</title>
    <link rel="icon" type="image/png" href="img/fenixstorelogo.png">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
    <link href="https://fonts.googleapis.com/css2?family=Outfit:wght@300;400;600;700&display=swap" rel="stylesheet">
    <style>
        :root {
            --primary-bg: #0f172a;
            --secondary-bg: #1e293b;
            --accent-color: #38bdf8;
            --text-main: #e2e8f0;
            --text-dim: #94a3b8;
            --danger: #ef4444;
            --success: #10b981;
            --glass: rgba(30, 41, 59, 0.7);
        }

        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            font-family: 'Outfit', sans-serif;
        }

        html,
        body {
            min-height: 100vh;
        }

        body {
            background-color: var(--primary-bg);
            color: var(--text-main);
            background-image:
                radial-gradient(circle at 10% 20%, rgba(56, 189, 248, 0.05) 0%, transparent 40%),
                radial-gradient(circle at 90% 80%, rgba(139, 92, 246, 0.05) 0%, transparent 40%);
            background-attachment: fixed;
            min-height: 100vh;
        }

        /* Navbar */
        .navbar {
            background: var(--glass);
            backdrop-filter: blur(12px);
            border-bottom: 1px solid rgba(255, 255, 255, 0.1);
            position: fixed;
            top: 0;
            width: 100%;
            z-index: 1000;
            padding: 0.75rem 2rem;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .logo {
            display: flex;
            align-items: center;
            gap: 10px;
            text-decoration: none;
            color: var(--accent-color);
            font-weight: 700;
            font-size: 1.5rem;
        }

        .logo img {
            height: 35px;
        }

        .nav-links {
            display: flex;
            gap: 20px;
            align-items: center;
        }

        .nav-link {
            color: var(--text-dim);
            text-decoration: none;
            transition: 0.3s;
            display: flex;
            align-items: center;
            gap: 8px;
            font-weight: 500;
        }

        .nav-link:hover,
        .nav-link.active {
            color: var(--accent-color);
        }

        /* Container */
        .container {
            max-width: 1200px;
            margin: 80px auto 0;
            display: grid;
            grid-template-columns: 280px 1fr 320px;
            gap: 2rem;
            padding: 1rem;
            align-items: start;
            /* CRITICAL: Allows sticky children to be shorter than container */
        }

        /* Sidebar */
        .sidebar {
            position: sticky;
            top: 90px;
            height: fit-content;
            z-index: 10;
        }

        .right-sidebar {
            position: sticky;
            top: 90px;
            height: fit-content;
            z-index: 10;
        }

        .feed {
            min-height: 100vh;
        }

        .profile-card {
            background: var(--secondary-bg);
            border-radius: 20px;
            padding: 1.5rem;
            text-align: center;
            border: 1px solid rgba(255, 255, 255, 0.05);
            margin-bottom: 1rem;
        }

        .profile-pic {
            width: 80px;
            height: 80px;
            border-radius: 50%;
            background: linear-gradient(45deg, var(--accent-color), #8b5cf6);
            margin: 0 auto 1rem;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 2rem;
            color: white;
            border: 3px solid var(--primary-bg);
            position: relative;
            overflow: visible !important;
        }

        .profile-pic img:not(.avatar-decoration) {
            width: 100%;
            height: 100%;
            object-fit: cover;
            border-radius: 50%;
        }

        .username {
            font-size: 1.25rem;
            font-weight: 700;
            margin-bottom: 0.25rem;
        }

        .user-handle {
            color: var(--text-dim);
            font-size: 0.9rem;
            margin-bottom: 1rem;
        }

        .profile-stats {
            display: flex;
            justify-content: space-around;
            padding-top: 1rem;
            border-top: 1px solid rgba(255, 255, 255, 0.1);
        }

        .stat-value {
            font-weight: 700;
            display: block;
        }

        .stat-label {
            font-size: 0.75rem;
            color: var(--text-dim);
        }

        /* Feed */
        .feed {
            display: flex;
            flex-direction: column;
            gap: 1.5rem;
        }

        .create-post {
            background: var(--secondary-bg);
            border-radius: 20px;
            padding: 1.5rem;
            border: 1px solid rgba(255, 255, 255, 0.05);
        }

        .post-input-wrapper {
            display: flex;
            gap: 12px;
        }

        .profile-pic-sm {
            width: 45px;
            height: 45px;
            border-radius: 50%;
            background: linear-gradient(45deg, var(--accent-color), #8b5cf6);
            flex-shrink: 0;
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: bold;
            position: relative;
            overflow: visible !important;
        }

        .profile-pic-sm img:not(.avatar-decoration) {
            width: 100%;
            height: 100%;
            object-fit: cover;
            border-radius: 50%;
        }

        #postContent {
            width: 100%;
            background: rgba(15, 23, 42, 0.5);
            border: 1px solid rgba(255, 255, 255, 0.1);
            border-radius: 12px;
            padding: 12px;
            color: white;
            min-height: 100px;
            max-height: 300px;
            overflow-y: auto;
            font-size: 1rem;
            outline: none;
            transition: 0.3s;
            line-height: 1.5;
            word-wrap: break-word;
        }

        #postContent:focus {
            border-color: var(--accent-color);
            background: rgba(15, 23, 42, 0.7);
        }

        [contenteditable=true]:empty:before {
            content: attr(placeholder);
            color: var(--text-dim);
            pointer-events: none;
            display: block;
        }

        .editor-sticker {
            width: 38px;
            height: 38px;
            vertical-align: middle;
            margin: 2px;
            object-fit: contain;
            display: inline-block;
            pointer-events: none;
        }

        .post-actions {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-top: 1rem;
        }

        .post-tools {
            display: flex;
            gap: 15px;
        }

        .tool-btn {
            background: none;
            border: none;
            color: var(--text-dim);
            cursor: pointer;
            font-size: 1.1rem;
            transition: 0.3s;
        }

        .tool-btn:hover {
            color: var(--accent-color);
        }

        .btn-post {
            background: var(--accent-color);
            color: var(--primary-bg);
            border: none;
            padding: 8px 24px;
            border-radius: 25px;
            font-weight: 700;
            cursor: pointer;
            transition: 0.3s;
        }

        .btn-post:hover {
            transform: scale(1.05);
        }

        /* Post Card */
        .post-card {
            background: var(--secondary-bg);
            border-radius: 20px;
            padding: 1.5rem;
            border: 1px solid rgba(255, 255, 255, 0.05);
            animation: fadeIn 0.5s ease;
            max-width: 100%;
            overflow: hidden;
        }

        .post-header {
            display: flex;
            align-items: center;
            gap: 12px;
            margin-bottom: 1rem;
        }

        .post-author-pic {
            width: 45px;
            height: 45px;
            border-radius: 50%;
            background: linear-gradient(45deg, #10b981, #3b82f6);
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: bold;
            position: relative;
            overflow: visible !important;
        }

        .post-author-pic img:not(.avatar-decoration) {
            width: 100%;
            height: 100%;
            object-fit: cover;
            border-radius: 50%;
        }

        .author-name {
            font-weight: 700;
            display: block;
        }

        .post-time {
            font-size: 0.8rem;
            color: var(--text-dim);
        }

        .post-content {
            margin-bottom: 1rem;
            line-height: 1.6;
            word-wrap: break-word;
            word-break: break-word;
            overflow-wrap: break-word;
            max-width: 100%;
            overflow: hidden;
        }

        .post-image {
            width: 100%;
            height: auto;
            border-radius: 12px;
            margin-bottom: 1rem;
            max-height: 600px;
            background: rgba(0, 0, 0, 0.2);
            display: block;
        }

        .post-footer {
            display: flex;
            gap: 20px;
            padding-top: 1rem;
            border-top: 1px solid rgba(255, 255, 255, 0.05);
        }

        .interaction-btn {
            background: none;
            border: none;
            color: var(--text-dim);
            cursor: pointer;
            display: flex;
            align-items: center;
            gap: 6px;
            font-size: 0.9rem;
        }

        .interaction-btn:hover {
            color: var(--accent-color);
        }

        .interaction-btn.active {
            color: var(--accent-color);
            font-weight: bold;
        }

        .interaction-btn.active i {
            font-weight: 900;
        }

        /* Trending Card */
        .right-sidebar {
            position: sticky;
            top: 100px;
            height: fit-content;
        }

        .trending-card {
            background: var(--secondary-bg);
            border-radius: 20px;
            padding: 1.5rem;
            border: 1px solid rgba(255, 255, 255, 0.05);
        }

        .trending-item {
            margin-bottom: 1.25rem;
        }

        .trend-category {
            font-size: 0.75rem;
            color: var(--text-dim);
            display: block;
        }

        .trend-name {
            font-weight: 600;
            display: block;
            margin: 2px 0;
        }

        .trend-stats {
            font-size: 0.75rem;
            color: var(--text-dim);
        }

        /* Profile View */
        .profile-view {
            background: var(--secondary-bg);
            border-radius: 25px;
            overflow: hidden;
            border: 1px solid rgba(255, 255, 255, 0.05);
            margin-bottom: 2rem;
        }

        .profile-banner {
            height: 180px;
            background: linear-gradient(135deg, #1e3c72, #2a5298, #38bdf8);
        }

        .profile-info-header {
            padding: 0 2rem 2rem;
            position: relative;
        }

        .profile-main-pic {
            width: 130px;
            height: 130px;
            border-radius: 50%;
            background: linear-gradient(45deg, #10b981, #3b82f6);
            border: 5px solid var(--secondary-bg);
            position: absolute;
            top: -65px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 3.5rem;
            font-weight: 700;
            color: white;
            overflow: visible !important;
            box-shadow: 0 5px 15px rgba(0, 0, 0, 0.3);
        }

        .profile-main-pic img:not(.avatar-decoration) {
            width: 100%;
            height: 100%;
            object-fit: cover;
            border-radius: 50%;
        }

        .avatar-decoration {
            position: absolute !important;
            top: 50% !important;
            left: 50% !important;
            transform: translate(-50%, -50%) !important;
            width: 125% !important;
            height: 125% !important;
            max-width: none !important;
            max-height: none !important;
            pointer-events: none;
            z-index: 999 !important;
            border-radius: 0 !important;
        }

        .profile-names {
            margin-top: 5rem;
        }

        .profile-bio {
            margin: 1.5rem 0;
            line-height: 1.6;
            white-space: pre-wrap;
        }

        .back-btn {
            background: none;
            border: none;
            color: var(--accent-color);
            cursor: pointer;
            display: flex;
            align-items: center;
            gap: 8px;
            margin-bottom: 1rem;
        }

        .icon-option {
            background: rgba(255, 255, 255, 0.05);
            border: 1px solid #333;
            border-radius: 10px;
            padding: 10px;
            text-align: center;
            cursor: pointer;
            font-size: 1.2rem;
            color: var(--text-dim);
            transition: 0.2s;
        }

        .icon-option:hover {
            background: rgba(255, 255, 255, 0.1);
        }

        .icon-option.selected {
            border-color: var(--accent-color);
            color: var(--accent-color);
            background: rgba(56, 189, 248, 0.1);
        }

        .emoji-picker {
            position: absolute;
            background: #111827;
            border: 1px solid #374151;
            border-radius: 16px;
            padding: 12px;
            display: grid;
            grid-template-columns: repeat(6, 1fr);
            gap: 8px;
            z-index: 2000;
            top: calc(100% + 10px);
            left: 0;
            box-shadow: 0 10px 40px rgba(0, 0, 0, 0.7);
            display: none;
            width: 280px;
            max-height: 250px;
            overflow-y: auto;
            overflow-x: hidden;
            scrollbar-width: thin;
            scrollbar-color: #4b5563 transparent;
        }

        .emoji-picker::-webkit-scrollbar {
            width: 6px;
        }

        .emoji-picker::-webkit-scrollbar-track {
            background: transparent;
        }

        .emoji-picker::-webkit-scrollbar-thumb {
            background: #4b5563;
            border-radius: 10px;
        }

        .emoji-picker::-webkit-scrollbar-thumb:hover {
            background: var(--accent-color);
        }

        .emoji-picker.active {
            display: grid;
            animation: pickerFadeIn 0.2s ease;
        }

        @keyframes pickerFadeIn {
            from {
                opacity: 0;
                transform: translateY(10px);
            }

            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        .emoji-btn {
            cursor: pointer;
            padding: 8px;
            font-size: 1.25rem;
            text-align: center;
            border-radius: 10px;
            transition: 0.2s;
            display: flex;
            align-items: center;
            justify-content: center;
            background: rgba(255, 255, 255, 0.03);
        }

        .emoji-btn img {
            width: 32px;
            height: 32px;
            object-fit: contain;
        }

        .emoji-btn:hover {
            background: rgba(255, 255, 255, 0.1);
        }

        .btn-delete {
            background: rgba(239, 68, 68, 0.1);
            color: #ef4444;
            border: none;
            padding: 4px 10px;
            border-radius: 8px;
            cursor: pointer;
            font-size: 0.75rem;
            margin-left: auto;
            display: flex;
            align-items: center;
            gap: 4px;
        }

        .btn-delete:hover {
            background: #ef4444;
            color: white;
        }

        /* Chat Mode (Discord Style) */
        .chat-container {
            display: flex;
            flex-direction: column;
            height: 70vh;
            max-height: 700px;
            background: var(--secondary-bg);
            border-radius: 20px;
            border: 1px solid rgba(255, 255, 255, 0.05);
            overflow-x: hidden;
            overflow-y: visible;
            position: relative;
        }

        .chat-header {
            padding: 1rem 1.5rem;
            background: rgba(0, 0, 0, 0.2);
            border-bottom: 1px solid rgba(255, 255, 255, 0.05);
            display: flex;
            align-items: center;
            gap: 12px;
        }

        .chat-messages {
            flex: 1;
            overflow-y: auto;
            padding: 1.5rem;
            display: flex;
            flex-direction: column;
            gap: 12px;
            scroll-behavior: smooth;
        }

        .chat-message {
            display: flex;
            gap: 12px;
            animation: fadeIn 0.3s ease;
        }

        .chat-msg-avatar {
            width: 40px;
            height: 40px;
            border-radius: 50%;
            background: #333;
            flex-shrink: 0;
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: bold;
            position: relative;
            overflow: visible !important;
        }

        .chat-msg-avatar img:not(.avatar-decoration) {
            width: 100%;
            height: 100%;
            object-fit: cover;
            border-radius: 50%;
        }

        .chat-msg-content {
            flex: 1;
        }

        .chat-msg-header {
            display: flex;
            align-items: baseline;
            gap: 8px;
            margin-bottom: 2px;
        }

        .chat-msg-author {
            color: var(--accent-color);
            font-weight: 600;
            font-size: 0.9rem;
            cursor: pointer;
        }

        .chat-msg-author:hover {
            text-decoration: underline;
        }

        .chat-msg-time {
            color: var(--text-dim);
            font-size: 0.7rem;
        }

        .chat-msg-text {
            color: #e2e8f0;
            line-height: 1.4;
            font-size: 0.95rem;
            word-wrap: break-word;
            word-break: break-word;
            overflow-wrap: break-word;
            max-width: 100%;
        }

        .chat-input-area {
            padding: 1rem 1.5rem;
            background: rgba(0, 0, 0, 0.1);
            border-top: 1px solid rgba(255, 255, 255, 0.05);
            overflow: visible;
            position: relative;
        }

        .chat-input-wrapper {
            background: #2d2d2d;
            border-radius: 8px;
            padding: 8px 12px;
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .chat-input-wrapper input {
            flex: 1;
            background: transparent;
            border: none;
            color: white;
            padding: 5px;
            outline: none;
        }

        @keyframes fadeIn {
            from {
                opacity: 0;
                transform: translateY(5px);
            }

            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        /* Modals */
        .modal-overlay {
            position: fixed;
            inset: 0;
            background: rgba(0, 0, 0, 0.8);
            backdrop-filter: blur(8px);
            z-index: 2000;
            display: none;
            align-items: center;
            justify-content: center;
        }

        .modal-overlay.active {
            display: flex;
        }

        .modal-card {
            background: var(--secondary-bg);
            width: 95%;
            max-width: 460px;
            padding: 2rem;
            border-radius: 20px;
            border: 1px solid rgba(255, 255, 255, 0.1);
            position: relative;
            max-height: 85vh;
            overflow-y: auto;
            overflow-x: hidden;
            scrollbar-width: thin;
            scrollbar-color: rgba(255, 255, 255, 0.1) transparent;
        }

        /* Ocultar barra si no es necesaria y estilizarla */
        .modal-card::-webkit-scrollbar {
            width: 6px;
        }

        .modal-card::-webkit-scrollbar-track {
            background: transparent;
        }

        .modal-card::-webkit-scrollbar-thumb {
            background: rgba(255, 255, 255, 0.1);
            border-radius: 10px;
        }

        .modal-card::-webkit-scrollbar-thumb:hover {
            background: var(--accent-color);
        }

        .form-group {
            margin-bottom: 1.25rem;
            text-align: left;
        }

        .form-group label {
            display: block;
            margin-bottom: 0.5rem;
            color: var(--text-dim);
            font-size: 0.9rem;
        }

        .form-group input,
        .form-group textarea {
            width: 100%;
            background: var(--primary-bg);
            border: 1px solid rgba(255, 255, 255, 0.1);
            border-radius: 10px;
            padding: 12px;
            color: white;
            outline: none;
        }

        .hidden {
            display: none !important;
        }

        /* Integration of index.html dark auth styles */
        .modal-content {
            background: linear-gradient(135deg, #1e3c72, #2a5298, #3d5fa8);
            padding: 40px;
            border-radius: 20px;
            box-shadow: 0 10px 40px rgba(0, 0, 0, 0.3);
            max-width: 450px;
            width: 90%;
            position: relative;
            animation: modalFadeTop 0.4s ease-out;
            color: white;
        }

        @keyframes modalFadeTop {
            from {
                opacity: 0;
                transform: translateY(-50px);
            }

            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        .modal-content h2 {
            color: #ffffff;
            margin-bottom: 25px;
            text-align: center;
            font-size: 28px;
            text-shadow: 2px 2px 4px rgba(0, 0, 0, 0.3);
        }

        .modal-close-btn {
            position: absolute;
            top: 15px;
            right: 15px;
            background: rgba(255, 255, 255, 0.1);
            border: 2px solid rgba(255, 255, 255, 0.3);
            color: white;
            width: 35px;
            height: 35px;
            border-radius: 50%;
            font-size: 20px;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: all 0.3s ease;
            font-weight: bold;
        }

        .modal-close-btn:hover {
            background: rgba(255, 77, 77, 0.8);
            border-color: rgba(255, 77, 77, 1);
            transform: rotate(90deg);
        }

        .error-message {
            background: #ff4d4d;
            color: white;
            padding: 10px;
            border-radius: 10px;
            margin-bottom: 15px;
            display: none;
        }

        .success-message {
            background: #28a745;
            color: white;
            padding: 10px;
            border-radius: 10px;
            margin-bottom: 15px;
            display: none;
        }

        .form-group label {
            display: block;
            color: #ffffff;
            font-weight: bold;
            margin-bottom: 8px;
            text-shadow: 1px 1px 2px rgba(0, 0, 0, 0.2);
            text-align: left;
        }

        .form-group input {
            width: 100%;
            padding: 12px;
            border: 2px solid rgba(255, 255, 255, 0.2);
            border-radius: 10px;
            font-size: 14px;
            transition: all 0.3s ease;
            background: rgba(255, 255, 255, 0.95);
            color: #2d2d2d;
        }

        .form-group input:focus {
            outline: none;
            border-color: #00d4ff;
            background: white;
            box-shadow: 0 0 10px rgba(0, 212, 255, 0.3);
        }

        .toggle-form {
            margin-top: 20px;
            text-align: center;
            font-size: 14px;
            color: rgba(255, 255, 255, 0.9);
        }

        .toggle-form a {
            color: #00d4ff;
            cursor: pointer;
            font-weight: bold;
            text-decoration: underline;
        }

        .toggle-form a:hover {
            color: #00ffff;
        }

        .btn-primary {
            width: 100%;
            padding: 12px;
            background: linear-gradient(135deg, #007bff, #0056b3);
            color: white;
            border: none;
            border-radius: 25px;
            font-size: 16px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
            margin-top: 10px;
        }

        .btn-primary:hover {
            transform: translateY(-2px);
            box-shadow: 0 6px 20px rgba(0, 123, 255, 0.4);
        }

        .btn-secondary {
            width: 100%;
            padding: 10px;
            background: linear-gradient(135deg, #6c757d, #495057);
            color: white;
            border: none;
            border-radius: 25px;
            cursor: pointer;
            transition: all 0.3s ease;
            margin-top: 10px;
        }

        .btn-secondary:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 15px rgba(0, 0, 0, 0.4);
        }

        @keyframes fadeIn {
            from {
                opacity: 0;
                transform: translateY(10px);
            }

            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        @media (max-width: 1024px) {
            .container {
                grid-template-columns: 80px 1fr;
            }

            .sidebar .stat-label,
            .sidebar .user-handle,
            .right-sidebar {
                display: none;
            }
        }

        @media (max-width: 768px) {
            .container {
                grid-template-columns: 1fr;
            }

            .sidebar {
                display: none;
            }
        }

        .fenix-alert {
            position: fixed;
            bottom: 20px;
            right: 20px;
            padding: 1rem 2rem;
            border-radius: 12px;
            background: var(--accent-color);
            color: var(--primary-bg);
            font-weight: 700;
            z-index: 3000;
            animation: slideIn 0.3s ease;
        }

        @keyframes slideIn {
            from {
                transform: translateX(100%);
                opacity: 0;
            }

            to {
                transform: translateX(0);
                opacity: 1;
            }
        }

        .comment-item {
            display: flex;
            gap: 12px;
            padding: 12px;
            background: rgba(255, 255, 255, 0.03);
            border-radius: 12px;
            border: 1px solid rgba(255, 255, 255, 0.05);
            animation: fadeIn 0.3s ease;
        }

        .comment-avatar {
            width: 35px;
            height: 35px;
            border-radius: 50%;
            background: var(--accent-color);
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 0.9rem;
            font-weight: 700;
            flex-shrink: 0;
            overflow: visible;
            position: relative;
        }

        .comment-avatar img:not(.avatar-decoration) {
            width: 100%;
            height: 100%;
            border-radius: 50%;
            object-fit: cover;
        }

        .comment-body {
            flex: 1;
        }

        .comment-author {
            font-weight: 600;
            font-size: 0.9rem;
            color: var(--accent-color);
            margin-bottom: 2px;
            cursor: pointer;
        }

        .comment-text {
            font-size: 0.85rem;
            color: var(--text-main);
            line-height: 1.4;
        }

        .comment-time {
            font-size: 0.7rem;
            color: var(--text-dim);
            margin-top: 4px;
        }

        .interaction-btn.active {
            color: var(--danger) !important;
        }

        .interaction-btn.active i {
            color: var(--danger) !important;
        }
    </style>
</head>

<body>
    <nav class="navbar">
        <a href="#" class="logo" onclick="showGlobalFeed(); return false;">
            <img src="img/fenixstorelogo.png" alt="Fenix Store">
            <span>Fenix Social</span>
        </a>
        <div class="nav-links">
            <a href="index.html" class="nav-link"><i class="fas fa-store"></i> Tienda</a>
            <a href="#" class="nav-link active" onclick="showGlobalFeed()"><i class="fas fa-home"></i> Inicio</a>
            <a href="#" class="nav-link" id="profileLink"><i class="fas fa-user"></i> Mi Perfil</a>
            <a href="status.html" class="nav-link"><i class="fas fa-heartbeat"></i> Estado</a>
            <button class="btn-post" id="loginBtnNav">Identificarse</button>
            <div id="userInfoNav" class="hidden" style="display:flex; align-items:center; gap:10px;">
                <span id="navUsername" style="font-weight:600; cursor:pointer;"
                    onclick="if(currentUser) viewProfile(currentUser.username)">Usuario</span>
                <button id="logoutBtn" class="tool-btn" title="Cerrar Sesión"><i
                        class="fas fa-sign-out-alt"></i></button>
            </div>
        </div>
    </nav>

    <div class="container">
        <aside class="sidebar">
            <div class="profile-card" id="sidebarProfileCard" style="cursor:pointer"
                onclick="if(currentUser) viewProfile(currentUser.username)">
                <div class="profile-pic" id="initialsContainer">F</div>
                <h3 class="username" id="sidebarUsername">Invitado</h3>
                <p class="user-handle" id="sidebarHandle">@invitado</p>
                <div class="profile-stats">
                    <div class="stat-item">
                        <span class="stat-value" id="sidebarPostStat">0</span>
                        <span class="stat-label">Posts</span>
                    </div>
                    <div class="stat-item">
                        <span class="stat-value" id="sidebarFollowersStat">0</span>
                        <span class="stat-label">Seguidores</span>
                    </div>
                </div>
            </div>
            <nav style="display: flex; flex-direction: column; gap: 10px;">
                <a href="#" class="nav-link active" onclick="showGlobalFeed(); return false;" id="navHome"
                    style="background: rgba(56, 189, 248, 0.1); padding: 12px; border-radius: 12px;">
                    <i class="fas fa-house"></i> Feed Global
                </a>
                <a href="#" class="nav-link" id="navTrends" style="padding: 12px;"
                    onclick="showTrends(); return false;">
                    <i class="fas fa-fire"></i> Tendencias
                </a>
                <a href="#" class="nav-link" id="navGroups" style="padding: 12px;"
                    onclick="showGroups(); return false;">
                    <i class="fas fa-users"></i> Grupos
                </a>
                <a href="#" class="nav-link" style="padding: 12px; color: #fbbf24;"
                    onclick="openGameSelector(); return false;">
                    <i class="fas fa-rocket"></i> Arcade P2E
                </a>
                <a href="aadmin.html" class="nav-link" style="padding: 12px;">
                    <i class="fas fa-lock"></i> Admin
                </a>
            </nav>
        </aside>

        <main class="feed">
            <div id="profileView" class="hidden">
                <button class="back-btn" onclick="showGlobalFeed()"
                    style="margin-bottom: 1rem; padding: 10px 20px; font-size: 1rem;">
                    <i class="fas fa-arrow-left"></i> Volver al Feed
                </button>
                <div class="profile-view">
                    <div class="profile-banner"></div>
                    <div class="profile-info-header">
                        <div class="profile-main-pic" id="profileMainPic">F</div>
                        <div style="display:flex; justify-content:flex-end; padding-top:1rem; gap:10px;">
                            <button id="followBtn" class="btn-post" style="display:none;"
                                onclick="toggleFollow()"></button>
                            <button id="editProfileBtn" class="btn-post"
                                style="display:none; background:transparent; border:1px solid var(--accent-color); color:var(--accent-color);"
                                onclick="openEditModal()">Editar Perfil</button>
                        </div>
                        <div class="profile-names">
                            <h2 id="profileFullUser">Usuario</h2>
                            <p id="profileFullHandle" class="user-handle">@usuario</p>
                        </div>
                        <div class="profile-stats" style="margin-top: 10px; justify-content: flex-start; gap: 20px;">
                            <div class="stat-item" style="cursor:pointer;" onclick="showFollowersListModal()">
                                <span class="stat-value" id="profileFollowersCount">0</span>
                                <span class="stat-label">Seguidores</span>
                            </div>
                            <div class="stat-item" style="cursor:pointer;" onclick="showFollowingListModal()">
                                <span class="stat-value" id="profileFollowingCount">0</span>
                                <span class="stat-label">Siguiendo</span>
                            </div>
                        </div>
                        <p id="profileBio" class="profile-bio">Sin biografía aún...</p>
                    </div>
                </div>
                <div id="profilePostsWrapper"></div>
            </div>

            <div id="globalFeed">
                <div class="create-post" id="createPostBox">
                    <div class="post-input-wrapper">
                        <div class="profile-pic-sm" id="userInitialsSmall">?</div>
                        <div id="postContent" contenteditable="true" placeholder="¿Qué está pasando en la comunidad?">
                        </div>
                    </div>
                    <div class="post-actions">
                        <div class="post-tools" style="position:relative;">
                            <button class="tool-btn" onclick="toggleImgInput()" title="Imagen"><i
                                    class="far fa-image"></i></button>
                            <button class="tool-btn" onclick="toggleEmojiPicker()" title="Emoji"><i
                                    class="far fa-grin"></i></button>
                            <div id="emojiPicker" class="emoji-picker">
                                <!-- Emojis se insertan via JS -->
                            </div>
                            <input type="text" id="imgUrlInput" placeholder="URL de imagen"
                                style="display:none; background:transparent; border:1px solid #444; color:white; border-radius:5px; padding:2px 5px; font-size:0.8rem;">
                        </div>
                        <button class="btn-post" id="publishBtn" disabled>Publicar</button>
                    </div>
                </div>
                <div id="postsWrapper" style="margin-top: 1.5rem;"></div>
            </div>

            <div id="groupsView" class="hidden">
                <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom: 1.5rem;">
                    <button class="back-btn" onclick="showGlobalFeed()" style="margin:0;"><i
                            class="fas fa-arrow-left"></i> Volver al Feed</button>
                    <button class="btn-post" onclick="openGroupModal()" style="font-size:0.8rem;"><i
                            class="fas fa-plus"></i> Crear Grupo</button>
                </div>
                <h2 style="margin-bottom: 1.5rem;"><i class="fas fa-users"></i> Grupos de la Comunidad</h2>
                <div id="groupsList"
                    style="display: grid; grid-template-columns: repeat(auto-fill, minmax(200px, 1fr)); gap: 1rem;">
                    <!-- Los grupos se cargarán aquí -->
                </div>
            </div>

            <div id="groupDetailView" class="hidden">
                <div class="chat-container">
                    <div class="chat-header">
                        <button class="back-btn" onclick="showGroups()" style="margin:0; font-size: 1.2rem;"><i
                                class="fas fa-arrow-left"></i></button>
                        <div id="groupPicChat"
                            style="width:40px; height:40px; border-radius:10px; overflow:hidden; background:rgba(255,255,255,0.05); display:flex; align-items:center; justify-content:center; font-size:1.2rem; color:var(--accent-color); flex-shrink:0;">
                        </div>
                        <div>
                            <h3 id="groupChatName" style="font-size:1rem; margin:0;">Nombre del Grupo</h3>
                            <p id="groupChatStatus" style="font-size:0.7rem; color:var(--text-dim); margin:0;">Cargando
                                chat...</p>
                        </div>
                        <div style="margin-left:auto;" id="groupActionBtnChat"></div>
                    </div>

                    <div class="chat-messages" id="groupChatMessages">
                        <!-- Mensajes en tiempo real -->
                    </div>

                    <div class="chat-input-area" id="groupChatInputArea" style="display:none;">
                        <div style="position: relative;">
                            <div id="emojiPickerGroup" class="emoji-picker"
                                style="bottom: 100%; top: auto; left: 0; margin-bottom: 5px;">
                                <!-- Emojis se insertan via JS -->
                            </div>
                            <div class="chat-input-wrapper"
                                style="display: flex; align-items: center; gap: 8px; padding: 8px 12px;">
                                <button class="tool-btn" onclick="toggleImgInputGroup()" title="Imagen"><i
                                        class="far fa-image"></i></button>
                                <button class="tool-btn" onclick="toggleEmojiPickerGroup()" title="Emoji"><i
                                        class="far fa-grin"></i></button>
                                <div id="groupMessageInput" contenteditable="true"
                                    placeholder="Enviar mensaje al grupo..."
                                    style="flex: 1; min-height: 36px; max-height: 100px; overflow-y: auto; background: #2d2d2d; border: 1px solid rgba(255, 255, 255, 0.1); border-radius: 8px; padding: 8px 12px; color: white; outline: none; line-height: 1.4; word-wrap: break-word;"
                                    onkeydown="if(event.key === 'Enter' && !event.shiftKey) { event.preventDefault(); publishGroupMessage(); }">
                                </div>
                                <button class="btn-post" id="groupSendBtn" onclick="publishGroupMessage()"
                                    style="padding: 8px 15px; border-radius: 6px; font-size: 0.85rem; flex-shrink: 0;">Enviar</button>
                            </div>
                            <input type="text" id="groupImgUrlInput" placeholder="URL de imagen opcional"
                                style="display:none; background:#1a1a1a; border:1px solid #444; color:white; border-radius:5px; padding:8px 12px; font-size:0.8rem; width: calc(100% - 24px); margin: 0 12px 8px 12px;">
                        </div>
                    </div>

                    <div id="chatNoMemberMsg"
                        style="padding: 1rem; text-align:center; background:rgba(0,0,0,0.2); color:var(--text-dim); font-size:0.85rem;">
                        Únete al grupo para participar en el chat.
                    </div>
                </div>
            </div>
            <div id="trendsView" class="hidden">
                <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom: 1.5rem;">
                    <button class="back-btn" onclick="showGlobalFeed()" style="margin:0;"><i
                            class="fas fa-arrow-left"></i> Volver al Feed</button>
                </div>
                <h2 style="margin-bottom: 1.5rem;"><i class="fas fa-fire"></i> Tendencias Populares</h2>
                <div id="allTrendsList"
                    style="display: grid; grid-template-columns: repeat(auto-fill, minmax(250px, 1fr)); gap: 1rem;">
                    <!-- Todas las tendencias se cargarán aquí -->
                </div>
            </div>
        </main>

        <aside class="right-sidebar">
            <div class="trending-card">
                <h3 style="margin-bottom:1rem;"><i class="fas fa-chart-line"></i> Tendencias</h3>
                <div id="trendingList">
                    <p style="color:var(--text-dim); font-size:0.8rem;">Cargando tendencias...</p>
                </div>
            </div>
        </aside>
    </div>

    <!-- Modals -->
    <div class="modal-overlay" id="editProfileModal">
        <div class="modal-card">
            <button class="modal-close-btn" onclick="closeEditModal()">×</button>
            <h2 style="margin-bottom:1.5rem;">Editar Perfil</h2>
            <div class="form-group">
                <label>Foto de Perfil (URL)</label>
                <input type="url" id="editAvatar">
            </div>
            <div class="form-group">
                <label>Imagen de Banner (URL)</label>
                <input type="url" id="editBanner">
            </div>
            <div class="form-group">
                <label>Biografía</label>
                <textarea id="editBio" rows="4"></textarea>
            </div>
            <div style="display:flex; gap:10px;">
                <button class="btn-post" onclick="saveProfile()" style="flex:1;">Guardar</button>
                <button class="btn-post" onclick="closeEditModal()"
                    style="background:transparent; color:white; border:1px solid #444;">Cancelar</button>
            </div>

            <hr style="border:0; border-top:1px solid #333; margin:20px 0;">

            <div id="discordLinkingSection">
                <h3 style="font-size:1rem; margin-bottom:10px;"><i class="fab fa-discord"></i> Vincular Discord</h3>
                <div id="discordGiftCard"
                    style="background: linear-gradient(135deg, rgba(139, 92, 246, 0.1), rgba(217, 70, 239, 0.1)); border: 1px solid rgba(139, 92, 246, 0.3); border-radius: 10px; padding: 12px; margin-bottom: 10px;">
                    <div style="display: flex; align-items: center; gap: 10px;">
                        <i class="fas fa-gift" style="color: #d946ef; font-size: 1.5rem;"></i>
                        <div style="flex: 1;">
                            <p style="font-size: 0.85rem; font-weight: 600; color: #d946ef; margin: 0;">¡Regalo de
                                Vinculación!</p>
                            <div style="display: flex; align-items: center; gap: 6px; margin-top: 4px;">
                                <p style="font-size: 0.75rem; color: var(--text-main); margin: 0; opacity: 0.9;">
                                    Desbloquea el sticker</p>
                                <img src="assets/facha.webp"
                                    style="width: 24px; height: 24px; vertical-align: middle; border-radius: 4px;">
                                <p style="font-size: 0.75rem; color: var(--text-main); margin: 0; opacity: 0.9;">
                                    <strong>Facha</strong>
                                </p>
                            </div>
                        </div>
                    </div>
                </div>
                <div id="discordStatus">Cargando estado...</div>
                <div id="discordActions" style="margin-top:10px; display:none;">
                    <button class="btn-post" onclick="generateLinkToken()"
                        style="background:#5865F2; border:none; width:100%;">Generar Token de Vinculación</button>
                </div>
                <div id="discordTokenDisplay"
                    style="display:none; margin-top:10px; padding:15px; background:rgba(88,101,242,0.1); border:1px dashed #5865F2; border-radius:10px; text-align:center;">
                    <p style="font-size:0.8rem; margin-bottom:10px;">Usa este comando en el canal del bot:</p>
                    <code id="discordTokenCode"
                        style="font-size:1.2rem; font-weight:bold; color:#5865F2; letter-spacing:2px;">TOKEN123</code>
                    <p style="font-size:0.7rem; margin-top:10px; opacity:0.7;">El token expira en 5 minutos.</p>
                </div>
                <div id="discordLinkedData"
                    style="display:none; margin-top:10px; padding:15px; background:rgba(0,255,0,0.05); border:1px solid rgba(0,255,0,0.2); border-radius:10px;">
                    <p style="font-size:0.9rem; margin-bottom:10px; color:#4ade80;">✅ Cuenta vinculada: <b
                            id="linkedDiscordUser">Nombre#0000</b></p>
                    <div style="display:grid; grid-template-columns:1fr 1fr; gap:8px;">
                        <button class="btn-post" onclick="useDiscordAvatar()"
                            style="font-size:0.75rem; padding:8px;">Usar Foto de Discord</button>
                        <button class="btn-post" onclick="useDiscordName()" style="font-size:0.75rem; padding:8px;">Usar
                            Nombre de Discord</button>
                    </div>
                    <div style="display:grid; grid-template-columns:1fr 1fr; gap:8px; margin-top:8px;">
                        <button id="useDiscordBannerBtn" class="btn-post" onclick="useDiscordBanner()"
                            style="font-size:0.75rem; padding:8px;">Usar Banner</button>
                        <button id="toggleDecoBtn" class="btn-post" onclick="toggleDecoration()"
                            style="font-size:0.75rem; padding:8px;">Usar Decoración</button>
                    </div>
                    <button class="btn-delete" onclick="unlinkDiscord()"
                        style="width:100%; margin-top:10px; padding:8px; font-size:0.75rem; background:rgba(239, 68, 68, 0.1); color:#ef4444; border:1px solid #ef4444; border-radius:10px;">
                        <i class="fas fa-unlink"></i> Desvincular Discord
                    </button>
                </div>
            </div>
        </div>
    </div>

    <div class="modal-overlay" id="commentModal">
        <div class="modal-card">
            <button class="modal-close-btn" onclick="closeCommentModal()">×</button>
            <h2 style="margin-bottom:1.5rem;"><i class="far fa-comments"></i> Comentarios</h2>
            <div id="commentsList"
                style="max-height: 350px; overflow-y: auto; margin-bottom: 1.5rem; padding-right: 5px; display: flex; flex-direction: column; gap: 1rem;">
                <!-- Comentarios se cargan aquí -->
                <p style="text-align:center; color:var(--text-dim); font-size:0.9rem;">Cargando comentarios...</p>
            </div>
            <div class="form-group" style="margin-bottom: 10px;">
                <div id="commentInput" contenteditable="true" placeholder="Escribe un comentario..."
                    style="width:100%; min-height:80px; max-height:200px; overflow-y:auto; border-radius:12px; padding:12px; background:rgba(15, 23, 42, 0.5); color:white; border:1px solid rgba(255,255,255,0.1); outline:none; transition:0.3s; word-wrap:break-word; line-height:1.5;">
                </div>
            </div>
            <button class="btn-post" id="submitCommentBtn" style="width:100%;">Publicar Comentario</button>
        </div>
    </div>

    <div class="modal-overlay" id="createGroupModal">
        <div class="modal-card">
            <button class="modal-close-btn" onclick="closeGroupModal()">×</button>
            <h2 style="margin-bottom:1.5rem;">Crear Nuevo Grupo</h2>
            <div class="form-group">
                <label>Nombre del Grupo</label>
                <input type="text" id="groupName" placeholder="Ej: Fenix Gamers">
            </div>
            <div class="form-group">
                <label>Descripción</label>
                <textarea id="groupDesc" rows="3" placeholder="¿De qué trata este grupo?"></textarea>
            </div>
            <div class="form-group">
                <label>Elegir Icono</label>
                <div id="groupIconSelector"
                    style="display:grid; grid-template-columns: repeat(5, 1fr); gap:10px; margin-top:10px;">
                    <div class="icon-option selected" data-icon="fa-users" onclick="selectGroupIcon(this)"><i
                            class="fas fa-users"></i></div>
                    <div class="icon-option" data-icon="fa-gamepad" onclick="selectGroupIcon(this)"><i
                            class="fas fa-gamepad"></i></div>
                    <div class="icon-option" data-icon="fa-code" onclick="selectGroupIcon(this)"><i
                            class="fas fa-code"></i></div>
                    <div class="icon-option" data-icon="fa-palette" onclick="selectGroupIcon(this)"><i
                            class="fas fa-palette"></i></div>
                    <div class="icon-option" data-icon="fa-rocket" onclick="selectGroupIcon(this)"><i
                            class="fas fa-rocket"></i></div>
                </div>
            </div>
            <div class="form-group">
                <label>O Imagen personalizada (URL)</label>
                <input type="url" id="groupImageUrl" placeholder="https://ejemplo.com/imagen.jpg">
            </div>
            <div style="display:flex; gap:10px; margin-top:20px;">
                <button class="btn-post" onclick="saveGroup()" style="flex:1;">Crear Grupo</button>
                <button class="btn-post" onclick="closeGroupModal()"
                    style="background:transparent; color:white; border:1px solid #444;">Cancelar</button>
            </div>
        </div>
    </div>

    <div class="modal-overlay" id="userListModal">
        <div class="modal-card">
            <button class="modal-close-btn" onclick="closeUserListModal()">×</button>
            <h2 id="userListTitle" style="margin-bottom:1.5rem;">Usuarios</h2>
            <div id="userListContent"
                style="max-height: 400px; overflow-y: auto; display: flex; flex-direction: column; gap: 10px;">
                <!-- Lista de usuarios se carga aquí -->
            </div>
        </div>
    </div>

    <!-- Login/Register Modal -->
    <div class="modal-overlay" id="authModal">
        <div class="modal-content">
            <button class="modal-close-btn" id="closeAuthModalX">×</button>
            <h2 id="authTitle" style="color:#1f2937; margin-bottom:20px; text-align:center;">Iniciar Sesión</h2>
            <div class="error-message" id="authError"></div>
            <div class="success-message" id="authSuccess"></div>

            <!-- Login Form -->
            <form id="loginForm" method="POST" action="javascript:void(0)">
                <div class="form-group">
                    <label for="loginUsername">Nombre de Usuario</label>
                    <input type="text" id="loginUsername" name="username" autocomplete="username" required
                        placeholder="Tu usuario" maxlength="20">
                </div>
                <div class="form-group">
                    <label for="loginPassword">Contraseña</label>
                    <input type="password" id="loginPassword" name="password" autocomplete="current-password" required
                        placeholder="••••••••" maxlength="50">
                </div>
                <div class="form-group"
                    style="display: flex; align-items: center; gap: 8px; margin-top: -10px; margin-bottom: 20px;">
                    <input type="checkbox" id="rememberLogin" style="width: auto; cursor: pointer;">
                    <label for="rememberLogin" style="margin-bottom: 0; cursor: pointer; font-size: 13px;">Recordar
                        contraseña</label>
                </div>
                <button type="submit" class="btn-primary">Entrar ahora</button>
            </form>

            <!-- Register Form -->
            <form id="registerForm" style="display: none;" method="POST" action="javascript:void(0)">
                <div class="form-group">
                    <label for="registerName">Nombre de Usuario</label>
                    <input type="text" id="registerName" name="username" autocomplete="username" required
                        placeholder="Ej: fenix_user" maxlength="20">
                </div>

                <div class="form-group">
                    <label for="registerPassword">Contraseña</label>
                    <input type="password" id="registerPassword" name="password" autocomplete="new-password" required
                        placeholder="Mínimo 6 caracteres" maxlength="50">
                </div>
                <div class="form-group">
                    <label for="registerPasswordConfirm">Confirmar Contraseña</label>
                    <input type="password" id="registerPasswordConfirm" name="password_confirm"
                        autocomplete="new-password" required placeholder="Repite tu contraseña" maxlength="50">
                </div>
                <button type="submit" class="btn-primary">Crear Cuenta</button>
            </form>

            <div class="toggle-form">
                <span id="toggleText">¿No tienes cuenta? <a id="toggleAuthForm">Regístrate aquí</a></span>
            </div>
            <button class="btn-secondary" id="closeAuthModal" style="margin-top:10px;">Cerrar</button>
        </div>
    </div>

    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-database-compat.js"></script>

    <script>
        const firebaseConfig = {
            apiKey: "AIzaSyBGQL-FXa6YiHuXRT0XM1HV4eTXqC0w0EA",
            authDomain: "fenixred-10f50.firebaseapp.com",
            databaseURL: "https://fenixred-10f50-default-rtdb.firebaseio.com",
            projectId: "fenixred-10f50",
            storageBucket: "fenixred-10f50.firebasestorage.app",
            messagingSenderId: "991164964450",
            appId: "1:991164964450:web:5320964d4b826187a37b3b",
            measurementId: "G-7HRDGY7R5N"
        };

        firebase.initializeApp(firebaseConfig);
        const database = firebase.database();
        let currentUser = null;

        function checkSession() {
            const saved = localStorage.getItem('fenixStoreUser') || sessionStorage.getItem('fenixStoreUser');
            if (saved) {
                currentUser = JSON.parse(saved);
                document.getElementById('loginBtnNav').classList.add('hidden');
                document.getElementById('userInfoNav').classList.remove('hidden');
                document.getElementById('navUsername').textContent = currentUser.username;
                updateSidebar(currentUser.username);
            }
        }

        async function updateSidebar(username) {
            const snap = await database.ref('fenixstore/social/users/' + username).once('value');
            const data = snap.val() || {};
            const initials = username.substring(0, 1).toUpperCase();

            document.getElementById('sidebarUsername').textContent = username;
            document.getElementById('sidebarHandle').textContent = '@' + username.toLowerCase();

            let picHtml = data.avatar ? `<img src="${data.avatar}">` : initials;
            if (data.decoration) picHtml += `<img src="${data.decoration}" class="avatar-decoration">`;

            document.getElementById('initialsContainer').innerHTML = picHtml;
            document.getElementById('userInitialsSmall').innerHTML = picHtml;
            document.getElementById('postContent').disabled = false;
            document.getElementById('postContent').placeholder = "¿Qué está pasando en la comunidad?";
            // Stats (Once, not real-time to save quota)
            database.ref('fenixstore/social/posts').orderByChild('author').equalTo(username).once('value', snap => {
                let globalPostsCount = 0;
                snap.forEach(child => {
                    if (!child.val().groupId) globalPostsCount++;
                });
                document.getElementById('sidebarPostStat').textContent = globalPostsCount;
            });

            // Seguidores en Sidebar
            database.ref('fenixstore/social/followers/' + username).on('value', snap => {
                const el = document.getElementById('sidebarFollowersStat');
                if (el) el.textContent = snap.numChildren();
            });

            showAlert("Sesión iniciada como " + username);

            // Fetch stickers for the user
            if (data.unlockedStickers) {
                userUnlockedStickers = data.unlockedStickers;
            }
        }

        function toggleImgInput() {
            const input = document.getElementById('imgUrlInput');
            input.style.display = input.style.display === 'none' ? 'block' : 'none';
        }

        document.getElementById('postContent').addEventListener('input', (e) => {
            const hasText = e.target.innerText.trim().length > 0;
            const hasImg = e.target.querySelector('img') !== null;
            document.getElementById('publishBtn').disabled = !hasText && !hasImg;
        });

        document.getElementById('publishBtn').addEventListener('click', async () => {
            if (!currentUser) {
                document.getElementById('authModal').classList.add('active');
                return;
            }

            const editor = document.getElementById('postContent');
            const text = parseEditorContent(editor);
            const image = document.getElementById('imgUrlInput').value.trim();

            if (!text && !image) return;

            try {
                const newPostData = {
                    author: currentUser.username,
                    text: text,
                    image: image || null,
                    timestamp: Date.now(),
                    likes: 0
                };

                const newRef = database.ref('fenixstore/social/posts').push();
                await newRef.set(newPostData);

                // Ver inmediatamente el post propio sin refrescar
                const wrapper = document.getElementById('postsWrapper');
                if (wrapper.querySelector('p')) wrapper.innerHTML = '';
                const newPostEl = await createPostElement({ id: newRef.key, ...newPostData }, false);
                wrapper.prepend(newPostEl);

                editor.innerHTML = '';
                document.getElementById('publishBtn').disabled = true;
                document.getElementById('imgUrlInput').value = '';
                document.getElementById('imgUrlInput').style.display = 'none';

                const currentStats = parseInt(document.getElementById('sidebarPostStat').textContent) || 0;
                document.getElementById('sidebarPostStat').textContent = currentStats + 1;

                showAlert("Post publicado");
            } catch (e) { showAlert("Error: " + e.message); }
        });

        function parseEditorContent(el) {
            // Clonar para no alterar el original
            const clone = el.cloneNode(true);

            // Reemplazar imágenes de stickers por su código [STK:url]
            const imgs = clone.querySelectorAll('img.editor-sticker');
            imgs.forEach(img => {
                const url = img.getAttribute('src');
                const textNode = document.createTextNode(`[STK:${url}]`);
                img.parentNode.replaceChild(textNode, img);
            });

            // Convertir <div> y <p> en saltos de línea para mantener el formato
            let text = clone.innerHTML;
            text = text.replace(/<div>/g, '\n').replace(/<\/div>/g, '');
            text = text.replace(/<p>/g, '\n').replace(/<\/p>/g, '');
            text = text.replace(/<br.*?>/g, '\n');

            const tmp = document.createElement('div');
            tmp.innerHTML = text;
            return tmp.innerText.trim();
        }

        async function loadFeed() {
            const wrapper = document.getElementById('postsWrapper');
            wrapper.innerHTML = '<p style="text-align:center; padding:2rem; color:var(--text-dim);">Cargando feed...</p>';

            try {
                const snap = await database.ref('fenixstore/social/posts').limitToLast(100).once('value');
                wrapper.innerHTML = '';

                const posts = [];
                snap.forEach(child => {
                    const val = child.val();
                    // Solo añadir si NO pertenece a un grupo (es un post global)
                    if (val && !val.groupId) posts.unshift({ id: child.key, ...val });
                });

                if (posts.length === 0) {
                    wrapper.innerHTML = '<p style="text-align:center; padding:2rem; color:var(--text-dim);">No hay publicaciones todavía. ¡Sé el primero!</p>';
                    return;
                }

                for (let p of posts) {
                    try {
                        const postEl = await createPostElement(p);
                        wrapper.appendChild(postEl);
                    } catch (err) {
                        console.error("Error al renderizar post:", p.id, err);
                    }
                }
            } catch (e) {
                console.error("Error fatal en feed:", e);
                wrapper.innerHTML = '<p style="text-align:center; padding:2rem; color:var(--danger);">Error al cargar el feed.</p>';
            }
        }

        async function createPostElement(post, isProfileView = false) {
            const div = document.createElement('div');
            div.className = 'post-card';
            div.style.marginBottom = '1rem';

            const author = post.author || "Anónimo";
            const text = post.text || "";
            const date = post.timestamp ? new Date(post.timestamp).toLocaleString() : "Fecha desconocida";
            const isLiked = currentUser && post.likedBy && post.likedBy[currentUser.username];
            const authorInitials = author.substring(0, 1).toUpperCase();

            const isAuthor = currentUser && post.author === currentUser.username;
            // El botón borrar solo aparece si es tu propia publicación Y estás viendo tu perfil
            const showDelete = isProfileView && isAuthor;

            div.innerHTML = `
                <div class="post-header" style="cursor:pointer">
                    <div class="user-profile-trigger" style="display:flex; align-items:center; gap:10px;">
                        <div class="post-author-pic" id="avatar-container-${post.id}">${escapeHtml(authorInitials)}</div>
                        <div>
                            <span class="author-name">${escapeHtml(author)}</span>
                            <span class="post-time">${escapeHtml(date)}</span>
                        </div>
                    </div>
                    ${showDelete ? `<button class="btn-delete" data-post-id="${post.id}"><i class="fas fa-trash"></i></button>` : ''}
                </div>
                <div class="post-content">${parseContent(text)}</div>
                ${post.gameCard ? `<div class="game-post-wrapper" style="margin-top:10px;">${post.gameCard}</div>` : ''}
                ${post.image ? `<img src="${escapeHtml(post.image)}" class="post-image" onerror="this.style.display='none'">` : ''}
                <div class="post-footer" style="display:flex; gap:15px; margin-top:10px;">
                    <button class="interaction-btn ${isLiked ? 'active' : ''}" onclick="likePost('${post.id}')" style="display:flex; align-items:center; gap:5px; background:none; border:none; color:${isLiked ? 'var(--danger)' : 'var(--text-dim)'}; cursor:pointer;">
                        <i class="${isLiked ? 'fas' : 'far'} fa-heart"></i> <span>${post.likes || 0}</span>
                    </button>
                    <button class="interaction-btn" onclick="openComments('${post.id}')" style="display:flex; align-items:center; gap:5px; background:none; border:none; color:var(--text-dim); cursor:pointer;">
                        <i class="far fa-comment"></i> <span>${post.commentsCount || 0}</span>
                    </button>
                </div>
            `;

            // Add event listeners safely
            const profileTrigger = div.querySelector('.user-profile-trigger');
            if (profileTrigger) profileTrigger.addEventListener('click', () => viewProfile(author));

            const deleteBtn = div.querySelector('.btn-delete');
            if (deleteBtn) deleteBtn.addEventListener('click', (e) => {
                e.stopPropagation();
                deletePost(post.id);
            });

            // Cargar avatar en segundo plano (sin bloquear el renderizado del feed)
            database.ref('fenixstore/social/users/' + post.author).once('value').then(snap => {
                const userData = snap.val() || {};
                const container = div.querySelector(`#avatar-container-${post.id}`);
                if (container) {
                    if (userData.avatar) {
                        container.innerHTML = `<img src="${userData.avatar}">`;
                    }
                    if (userData.decoration) {
                        const decoImg = document.createElement('img');
                        decoImg.src = userData.decoration;
                        decoImg.className = 'avatar-decoration';
                        container.appendChild(decoImg);
                    }
                }
            });

            return div;
        }

        async function viewProfile(username) {
            hideAllViews();
            const view = document.getElementById('profileView');
            view.classList.remove('hidden');

            document.getElementById('profileFullUser').textContent = username;
            document.getElementById('profileFullHandle').textContent = '@' + username.toLowerCase();

            try {
                const userSnap = await database.ref('fenixstore/social/users/' + username).once('value');
                const userData = userSnap.val() || {};

                // Aplicar Banner
                const bannerEl = view.querySelector('.profile-banner');
                if (userData.banner) {
                    bannerEl.style.background = `url('${userData.banner}') center/cover no-repeat`;
                } else {
                    bannerEl.style.background = 'linear-gradient(135deg, #1e3c72, #2a5298, #38bdf8)';
                }

                // Perfil con Decoración si existe
                let picContent = userData.avatar ? `<img src="${userData.avatar}">` : username.substring(0, 1).toUpperCase();
                if (userData.decoration) {
                    picContent += `<img src="${userData.decoration}" class="avatar-decoration">`;
                }
                document.getElementById('profileMainPic').innerHTML = picContent;

                document.getElementById('profileBio').textContent = userData.bio || "Sin biografía aún...";

                const discordBadge = view.querySelector('.discord-badge');
                if (discordBadge) discordBadge.remove();

                if (userData.discordUsername) {
                    const badge = document.createElement('div');
                    badge.className = 'discord-badge';
                    badge.style = "display:inline-flex; align-items:center; gap:5px; background:rgba(88,101,242,0.1); color:#5865F2; padding:4px 10px; border-radius:20px; font-size:0.8rem; margin-top:10px;";
                    badge.innerHTML = `<i class="fab fa-discord"></i> ${userData.discordUsername}`;
                    document.getElementById('profileBio').after(badge);
                }

                document.getElementById('editProfileBtn').style.display = (currentUser && currentUser.username === username) ? 'block' : 'none';

                const pWrapper = document.getElementById('profilePostsWrapper');
                pWrapper.innerHTML = '<p style="text-align:center; padding:1rem; color:var(--text-dim);">Cargando publicaciones...</p>';

                const postsSnap = await database.ref('fenixstore/social/posts').orderByChild('author').equalTo(username).once('value');
                pWrapper.innerHTML = '';
                const posts = [];
                postsSnap.forEach(c => {
                    const p = c.val();
                    // Solo posts que NO sean de grupo
                    if (p && !p.groupId) posts.unshift({ id: c.key, ...p });
                });

                if (posts.length === 0) {
                    pWrapper.innerHTML = '<p style="text-align:center; padding:2rem; color:var(--text-dim);">No hay publicaciones de este usuario todavía.</p>';
                } else {
                    for (let p of posts) {
                        pWrapper.appendChild(await createPostElement(p, true));
                    }
                }

                // Seguidores logic
                updateFollowStats(username);
                if (currentUser && currentUser.username !== username) {
                    checkFollowingStatus(username);
                } else {
                    document.getElementById('followBtn').style.display = 'none';
                }

            } catch (e) {
                console.error(e);
                showAlert("Error al cargar el perfil");
            }
        }

        let currentProfileUser = null;

        async function updateFollowStats(username) {
            currentProfileUser = username;
            // Seguidores
            database.ref('fenixstore/social/followers/' + username).on('value', snap => {
                const count = snap.numChildren();
                const el = document.getElementById('profileFollowersCount');
                if (el) el.textContent = count;
            });
            // Siguiendo
            database.ref('fenixstore/social/following/' + username).on('value', snap => {
                const count = snap.numChildren();
                const el = document.getElementById('profileFollowingCount');
                if (el) el.textContent = count;
            });
        }

        async function checkFollowingStatus(targetUser) {
            if (!currentUser) return;
            const followBtn = document.getElementById('followBtn');
            database.ref(`fenixstore/social/followers/${targetUser}/${currentUser.username}`).on('value', snap => {
                const isFollowing = snap.exists();
                followBtn.style.display = 'block';
                if (isFollowing) {
                    followBtn.textContent = 'Siguiendo';
                    followBtn.style.background = 'transparent';
                    followBtn.style.border = '1px solid #444';
                    followBtn.style.color = 'var(--text-dim)';
                } else {
                    followBtn.textContent = 'Seguir';
                    followBtn.style.background = 'var(--accent-color)';
                    followBtn.style.border = 'none';
                    followBtn.style.color = 'white';
                }
                followBtn.dataset.following = isFollowing;
            });
        }

        async function toggleFollow() {
            if (!currentUser) return document.getElementById('authModal').classList.add('active');
            if (!currentProfileUser) return;
            const followBtn = document.getElementById('followBtn');
            const isFollowing = followBtn.dataset.following === 'true';
            const followersRef = database.ref(`fenixstore/social/followers/${currentProfileUser}/${currentUser.username}`);
            const followingRef = database.ref(`fenixstore/social/following/${currentUser.username}/${currentProfileUser}`);
            try {
                if (isFollowing) {
                    await followersRef.remove();
                    await followingRef.remove();
                    showAlert("Has dejado de seguir a " + currentProfileUser);
                } else {
                    await followersRef.set(true);
                    await followingRef.set(true);
                    showAlert("Ahora sigues a " + currentProfileUser);
                }
            } catch (e) { showAlert("Error: " + e.message); }
        }

        async function showFollowersListModal() {
            if (!currentProfileUser) return;
            const modal = document.getElementById('userListModal');
            const list = document.getElementById('userListContent');
            const title = document.getElementById('userListTitle');
            title.textContent = "Seguidores de " + currentProfileUser;
            list.innerHTML = '<p style="text-align:center; color:var(--text-dim);">Cargando...</p>';
            modal.classList.add('active');
            const snap = await database.ref('fenixstore/social/followers/' + currentProfileUser).once('value');
            list.innerHTML = '';
            if (!snap.exists()) {
                list.innerHTML = '<p style="text-align:center; color:var(--text-dim); padding:1rem;">No tiene seguidores aún.</p>';
                return;
            }
            snap.forEach(child => { list.appendChild(createUserListItem(child.key)); });
        }

        async function showFollowingListModal() {
            if (!currentProfileUser) return;
            const modal = document.getElementById('userListModal');
            const list = document.getElementById('userListContent');
            const title = document.getElementById('userListTitle');
            title.textContent = "Seguidos por " + currentProfileUser;
            list.innerHTML = '<p style="text-align:center; color:var(--text-dim);">Cargando...</p>';
            modal.classList.add('active');
            const snap = await database.ref('fenixstore/social/following/' + currentProfileUser).once('value');
            list.innerHTML = '';
            if (!snap.exists()) {
                list.innerHTML = '<p style="text-align:center; color:var(--text-dim); padding:1rem;">No sigue a nadie aún.</p>';
                return;
            }
            snap.forEach(child => { list.appendChild(createUserListItem(child.key)); });
        }

        function closeUserListModal() { document.getElementById('userListModal').classList.remove('active'); }

        function createUserListItem(username) {
            const div = document.createElement('div');
            div.className = 'user-list-item';
            div.style = "display:flex; align-items:center; gap:12px; padding:10px; background:rgba(255,255,255,0.03); border-radius:10px; cursor:pointer; transition: 0.2s;";
            div.onmouseover = () => div.style.background = 'rgba(255,255,255,0.08)';
            div.onmouseout = () => div.style.background = 'rgba(255,255,255,0.03)';
            div.onclick = () => { closeUserListModal(); viewProfile(username); };
            const initials = username.charAt(0).toUpperCase();
            div.innerHTML = `
                    <div class="profile-pic-sm" id="list-avatar-${username}">${initials}</div>
                    <div style="flex:1;">
                        <div style="font-weight:600; color:var(--accent-color);">@${username}</div>
                    </div>
                    <i class="fas fa-chevron-right" style="opacity:0.3; font-size:0.8rem;"></i>
                `;
            database.ref('fenixstore/social/users/' + username).once('value').then(snap => {
                const data = snap.val() || {};
                const container = div.querySelector(`#list-avatar-${username}`);
                if (container && data.avatar) {
                    container.innerHTML = `<img src="${data.avatar}" style="width:100%; height:100%; object-fit:cover; border-radius:inherit;">`;
                }
            });
            return div;
        }

        function hideAllViews() {
            document.getElementById('globalFeed').classList.add('hidden');
            document.getElementById('profileView').classList.add('hidden');
            document.getElementById('groupsView').classList.add('hidden');
            document.getElementById('groupDetailView').classList.add('hidden');
            document.getElementById('trendsView').classList.add('hidden');

            // Detener listeners de chat si existen
            if (activeChatRef) activeChatRef.off();
        }

        function showGlobalFeed() {
            hideAllViews();
            document.getElementById('globalFeed').classList.remove('hidden');

            // Re-load full feed
            loadFeed();

            // Reset nav active states
            document.querySelectorAll('.nav-link').forEach(l => l.classList.remove('active'));
            document.getElementById('navHome').classList.add('active');
        }

        async function loadTrending() {
            const snap = await database.ref('fenixstore/social/posts').limitToLast(100).once('value');
            const hashtags = {};

            snap.forEach(child => {
                const text = child.val().text || "";
                const matches = text.match(/#[a-zA-Z0-9_áéíóúñÁÉÍÓÚÑ]+/g);
                if (matches) {
                    matches.forEach(tag => {
                        hashtags[tag] = (hashtags[tag] || 0) + 1;
                    });
                }
            });

            const sorted = Object.entries(hashtags).sort((a, b) => b[1] - a[1]).slice(0, 5);
            const list = document.getElementById('trendingList');
            list.innerHTML = '';

            if (sorted.length === 0) {
                list.innerHTML = '<p style="color:var(--text-dim); font-size:0.8rem;">No hay tendencias aún.</p>';
                return;
            }

            sorted.forEach(([tag, count]) => {
                const div = document.createElement('div');
                div.className = 'trending-item';
                div.style.cursor = 'pointer';
                div.innerHTML = `
                    <span class="trend-category">Tendencia</span>
                    <span class="trend-name">${tag}</span>
                    <span class="trend-stats">${count} posts</span>
                `;
                div.onclick = () => filterFeedByTag(tag);
                list.appendChild(div);
            });
        }

        async function showTrends() {
            hideAllViews();
            document.getElementById('trendsView').classList.remove('hidden');

            document.querySelectorAll('.nav-link').forEach(l => l.classList.remove('active'));
            document.getElementById('navTrends').classList.add('active');

            loadAllTrending();
        }

        async function loadAllTrending() {
            const list = document.getElementById('allTrendsList');
            list.innerHTML = '<p style="text-align:center; grid-column: 1/-1; padding:2rem; color:var(--text-dim);">Cargando tendencias...</p>';

            const snap = await database.ref('fenixstore/social/posts').limitToLast(200).once('value');
            const hashtags = {};

            snap.forEach(child => {
                const text = child.val().text || "";
                const matches = text.match(/#[a-zA-Z0-9_áéíóúñÁÉÍÓÚÑ]+/g);
                if (matches) {
                    matches.forEach(tag => {
                        hashtags[tag] = (hashtags[tag] || 0) + 1;
                    });
                }
            });

            const sorted = Object.entries(hashtags).sort((a, b) => b[1] - a[1]);
            list.innerHTML = '';

            if (sorted.length === 0) {
                list.innerHTML = '<p style="text-align:center; grid-column: 1/-1; padding:2rem; color:var(--text-dim);">No hay tendencias todavía. ¡Sé el primero en usar un hashtag!</p>';
                return;
            }

            sorted.forEach(([tag, count], index) => {
                const div = document.createElement('div');
                div.className = 'profile-card';
                div.style.cursor = 'pointer';
                div.style.textAlign = 'left';
                div.onclick = () => filterFeedByTag(tag);

                const rankColor = index < 3 ? 'var(--accent-color)' : 'var(--text-dim)';
                const rankIcon = index === 0 ? '🥇' : index === 1 ? '🥈' : index === 2 ? '🥉' : `#${index + 1}`;

                div.innerHTML = `
                    <div style="display:flex; align-items:center; gap:12px; margin-bottom:1rem;">
                        <div style="font-size:1.5rem; color:${rankColor}; font-weight:700; min-width:40px;">${rankIcon}</div>
                        <div style="flex:1;">
                            <h3 style="margin:0; color:var(--accent-color); font-size:1.1rem;">${tag}</h3>
                            <p style="margin:0; font-size:0.8rem; color:var(--text-dim);">${count} publicaciones</p>
                        </div>
                    </div>
                    <div style="font-size:0.75rem; color:var(--text-dim);">Click para ver posts</div>
                `;
                list.appendChild(div);
            });
        }

        async function filterFeedByTag(tag) {
            showGlobalFeed();
            const snap = await database.ref('fenixstore/social/posts').once('value');
            const wrapper = document.getElementById('postsWrapper');
            wrapper.innerHTML = `
                <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:1rem;">
                    <h3 style="color:var(--accent-color); margin:0;">Posts con ${tag}</h3>
                    <button class="btn-post" onclick="loadFeed()" style="padding:6px 12px; font-size:0.8rem;">Ver todo el feed</button>
                </div>
            `;

            const posts = [];
            snap.forEach(child => {
                const p = child.val();
                // Solo posts públicos (sin groupId) y que contengan el tag
                if (p && !p.groupId && p.text && p.text.includes(tag)) {
                    posts.unshift({ id: child.key, ...p });
                }
            });

            if (posts.length === 0) {
                wrapper.innerHTML += '<p style="text-align:center; padding:2rem; color:var(--text-dim);">No hay publicaciones con este hashtag todavía.</p>';
            } else {
                for (let p of posts) wrapper.appendChild(await createPostElement(p, false));
            }

            window.scrollTo({ top: 0, behavior: 'smooth' });
        }

        async function showGroups() {
            hideAllViews();
            document.getElementById('groupsView').classList.remove('hidden');

            document.querySelectorAll('.nav-link').forEach(l => l.classList.remove('active'));
            document.getElementById('navGroups').classList.add('active');

            loadGroups();
        }

        async function loadGroups() {
            const list = document.getElementById('groupsList');
            list.innerHTML = '<p style="text-align:center; grid-column: 1/-1; padding:2rem; color:var(--text-dim);">Cargando grupos...</p>';

            try {
                const snap = await database.ref('fenixstore/social/groups').once('value');
                list.innerHTML = '';
                const groups = [];
                snap.forEach(child => groups.push({ id: child.key, ...child.val() }));

                if (groups.length === 0) {
                    list.innerHTML = '<p style="text-align:center; grid-column: 1/-1; padding:2rem; color:var(--text-dim);">No hay grupos todavía. ¡Sé el primero en crear uno!</p>';
                    return;
                }

                groups.forEach(g => {
                    const isMember = currentUser && g.members && g.members[currentUser.username];
                    const memberCount = g.members ? Object.keys(g.members).length : 0;

                    const div = document.createElement('div');
                    div.className = 'profile-card';
                    div.style.textAlign = 'left';

                    let imageHtml = `<div style="font-size:2.5rem; color:var(--accent-color); margin-bottom:1rem; width:60px; height:60px; display:flex; align-items:center; justify-content:center; background:rgba(255,255,255,0.05); border-radius:15px;"><i class="fas ${g.icon || 'fa-users'}"></i></div>`;
                    if (g.image) {
                        imageHtml = `<div style="width:60px; height:60px; border-radius:15px; overflow:hidden; margin-bottom:1rem; border:1px solid rgba(255,255,255,0.1);"><img src="${g.image}" style="width:100%; height:100%; object-fit:cover;"></div>`;
                    }

                    div.innerHTML = `
                        <div style="cursor:pointer" onclick="viewGroup('${g.id}')">
                            ${imageHtml}
                            <h3 style="margin-bottom:0.5rem; white-space:nowrap; overflow:hidden; text-overflow:ellipsis;">${escapeHtml(g.name)}</h3>
                            <p style="font-size:0.8rem; color:var(--text-dim); margin-bottom:1rem; height:40px; overflow:hidden;">${escapeHtml(g.description || "")}</p>
                        </div>
                        <div style="display:flex; justify-content:space-between; align-items:center;">
                            <span style="font-size:0.75rem; color:var(--text-dim);"><i class="fas fa-user-friends"></i> ${memberCount}</span>
                            <button class="btn-post" 
                                onclick="${isMember ? `leaveGroup('${g.id}')` : `joinGroup('${g.id}')`}" 
                                style="padding:6px 14px; font-size:0.8rem; ${isMember ? 'background: rgba(239, 68, 68, 0.1); color: #ef4444; border: 1px solid #ef4444;' : 'background: var(--accent-color); color: white; border: none;'}">
                                <i class="fas ${isMember ? 'fa-sign-out-alt' : 'fa-user-plus'}"></i> ${isMember ? 'Salir' : 'Unirse'}
                            </button>
                        </div>
                    `;
                    list.appendChild(div);
                });
            } catch (e) {
                console.error(e);
                list.innerHTML = '<p style="text-align:center; grid-column: 1/-1; padding:2rem; color:var(--danger);">Error al cargar grupos.</p>';
            }
        }

        function openGroupModal() {
            if (!currentUser) return document.getElementById('authModal').classList.add('active');
            document.getElementById('createGroupModal').classList.add('active');
        }
        function closeGroupModal() { document.getElementById('createGroupModal').classList.remove('active'); }

        let selectedIcon = "fa-users";
        function selectGroupIcon(el) {
            document.querySelectorAll('#groupIconSelector .icon-option').forEach(opt => opt.classList.remove('selected'));
            el.classList.add('selected');
            selectedIcon = el.dataset.icon;
        }

        async function saveGroup() {
            const name = document.getElementById('groupName').value.trim();
            const desc = document.getElementById('groupDesc').value.trim();
            const image = document.getElementById('groupImageUrl').value.trim();

            if (!name) return showAlert("Ponle un nombre al grupo");

            try {
                const groupData = {
                    name,
                    description: desc,
                    icon: selectedIcon,
                    image: image || null,
                    creator: currentUser.username,
                    members: { [currentUser.username]: true },
                    createdAt: Date.now()
                };

                await database.ref('fenixstore/social/groups').push(groupData);
                showAlert("¡Grupo creado con éxito!");
                closeGroupModal();
                loadGroups();

                // Limpiar form
                document.getElementById('groupName').value = '';
                document.getElementById('groupDesc').value = '';
                document.getElementById('groupImageUrl').value = '';
            } catch (e) { showAlert("Error: " + e.message); }
        }

        async function joinGroup(groupId) {
            if (!currentUser) return document.getElementById('authModal').classList.add('active');
            try {
                await database.ref(`fenixstore/social/groups/${groupId}/members/${currentUser.username}`).set(true);
                showAlert("Te has unido al grupo");
                loadGroups();
                if (currentGroupId === groupId) { // If currently viewing this group, update its state
                    viewGroup(groupId);
                }
            } catch (e) { showAlert("Error: " + e.message); }
        }

        async function leaveGroup(groupId) {
            if (!confirm("¿Estás seguro de que quieres salir de este grupo?")) {
                return;
            }
            try {
                await database.ref(`fenixstore/social/groups/${groupId}/members/${currentUser.username}`).remove();
                showAlert("Has salido del grupo");
                loadGroups();
                if (currentGroupId === groupId) {
                    viewGroup(groupId);
                }
            } catch (e) { showAlert("Error: " + e.message); }
        }

        let activeChatRef = null;
        let currentGroupId = null;

        async function viewGroup(groupId) {
            hideAllViews();
            document.getElementById('groupDetailView').classList.remove('hidden');

            const snap = await database.ref(`fenixstore/social/groups/${groupId}`).once('value');
            const g = snap.val();
            if (!g) return;

            currentGroupId = groupId; // Set the current group ID

            document.getElementById('groupChatName').textContent = g.name;

            const pic = document.getElementById('groupPicChat');
            if (g.image) {
                pic.innerHTML = `<img src="${g.image}" style="width:100%; height:100%; object-fit:cover;">`;
            } else {
                pic.innerHTML = `<i class="fas ${g.icon || 'fa-users'}"></i>`;
            }

            const isMember = currentUser && g.members && g.members[currentUser.username];
            const memberCount = g.members ? Object.keys(g.members).length : 0;
            document.getElementById('groupChatStatus').textContent = `${memberCount} miembros`;

            document.getElementById('groupActionBtnChat').innerHTML = `
                <button class="btn-post" 
                    onclick="${isMember ? `leaveGroup('${groupId}')` : `joinGroup('${groupId}')`}" 
                    style="padding: 6px 14px; font-size: 0.8rem; ${isMember ? 'background: rgba(239, 68, 68, 0.1); color: #ef4444; border: 1px solid #ef4444;' : 'background: var(--accent-color); color: white; border: none;'}">
                    <i class="fas ${isMember ? 'fa-sign-out-alt' : 'fa-user-plus'}"></i> ${isMember ? 'Salir del Grupo' : 'Unirse'}
                </button>
            `;

            if (isMember) {
                document.getElementById('groupChatInputArea').style.display = 'block';
                document.getElementById('chatNoMemberMsg').style.display = 'none';
            } else {
                document.getElementById('groupChatInputArea').style.display = 'none';
                document.getElementById('chatNoMemberMsg').style.display = 'block';
            }

            loadGroupChat(groupId);
        }

        async function loadGroupChat(groupId) {
            const container = document.getElementById('groupChatMessages');
            container.innerHTML = '';

            if (activeChatRef) activeChatRef.off();
            activeChatRef = database.ref('fenixstore/social/posts').orderByChild('groupId').equalTo(groupId);

            activeChatRef.on('child_added', async (snap) => {
                const msg = snap.val();
                const msgEl = await createChatMessageElement({ id: snap.key, ...msg });
                container.appendChild(msgEl);
                container.scrollTop = container.scrollHeight;
            });
        }

        async function createChatMessageElement(msg) {
            const div = document.createElement('div');
            div.className = 'chat-message';

            const userSnap = await database.ref('fenixstore/social/users/' + msg.author).once('value');
            const userData = userSnap.val() || {};
            let avatarHtml = userData.avatar ? `<img src="${userData.avatar}">` : msg.author.charAt(0).toUpperCase();

            // Añadir decoración si existe
            if (userData.decoration) {
                avatarHtml += `<img src="${userData.decoration}" class="avatar-decoration">`;
            }

            const time = new Date(msg.timestamp).toLocaleTimeString([], { hour: '2-digit', minute: '2-digit' });

            div.innerHTML = `
                <div class="chat-msg-avatar" onclick="viewProfile('${msg.author}')" style="cursor:pointer">${avatarHtml}</div>
                <div class="chat-msg-content">
                    <div class="chat-msg-header">
                        <span class="chat-msg-author" onclick="viewProfile('${msg.author}')">${msg.author}</span>
                        <span class="chat-msg-time">${time}</span>
                    </div>
                    <div class="chat-msg-text">${parseContent(msg.text)}</div>
                    ${msg.image ? `<img src="${msg.image}" style="max-width:100%; max-height:350px; border-radius:12px; margin-top:8px; display:block; border: 1px solid rgba(255,255,255,0.05);" onerror="this.style.display='none'">` : ''}
                </div>
            `;
            return div;
        }

        async function publishGroupMessage() {
            const input = document.getElementById('groupMessageInput');
            const imgInput = document.getElementById('groupImgUrlInput');
            const text = parseEditorContent(input);
            const image = imgInput.value.trim();

            if (!currentGroupId) return; // Ensure we have a group ID

            if (!text && !image) return;

            try {
                const msgData = {
                    author: currentUser.username,
                    text: text,
                    image: image || null,
                    timestamp: Date.now(),
                    groupId: currentGroupId
                };

                await database.ref('fenixstore/social/posts').push(msgData);
                input.innerHTML = '';
                imgInput.value = '';
                imgInput.style.display = 'none';
            } catch (e) { showAlert("Error: " + e.message); }
        }

        function toggleImgInputGroup() {
            const input = document.getElementById('groupImgUrlInput');
            input.style.display = input.style.display === 'none' ? 'block' : 'none';
        }

        document.getElementById('groupPostContent')?.addEventListener('input', (e) => {
            document.getElementById('groupPublishBtn').disabled = e.target.value.trim() === '';
        });

        async function openEditModal() {
            document.getElementById('editProfileModal').classList.add('active');
            if (!currentUser) return;

            const snap = await database.ref('fenixstore/social/users/' + currentUser.username).once('value');
            const data = snap.val() || {};
            document.getElementById('editAvatar').value = data.avatar || '';
            document.getElementById('editBanner').value = data.banner || '';
            document.getElementById('editBio').value = data.bio || '';

            // Cargar decoración actual al estado del modal
            if (data.decoration) {
                document.getElementById('editProfileModal').dataset.tempDeco = data.decoration;
            } else {
                delete document.getElementById('editProfileModal').dataset.tempDeco;
            }

            const status = document.getElementById('discordStatus');
            const actions = document.getElementById('discordActions');
            const linked = document.getElementById('discordLinkedData');
            const tokenDisp = document.getElementById('discordTokenDisplay');

            tokenDisp.style.display = 'none';

            // Verificar si el usuario tiene el sticker Facha
            const giftCard = document.getElementById('discordGiftCard');
            const hasFachaSticker = data.unlockedStickers && data.unlockedStickers.includes('assets/facha.webp');

            // Ocultar tarjeta de regalo si ya tiene el sticker
            if (hasFachaSticker) {
                giftCard.style.display = 'none';
            } else {
                giftCard.style.display = 'block';
            }

            if (data.discordId) {
                status.innerHTML = '<span style="color:#4ade80;">Conectado a Discord</span>';
                actions.style.display = 'none';
                linked.style.display = 'block';
                document.getElementById('linkedDiscordUser').textContent = data.discordUsername || 'Usuario de Discord';

                // Actualizar estados visuales de los botones
                const bannerBtn = document.getElementById('useDiscordBannerBtn');
                const decoBtn = document.getElementById('toggleDecoBtn');

                if (data.discordBanner) {
                    bannerBtn.style.opacity = "1";
                    bannerBtn.style.cursor = "pointer";
                } else {
                    bannerBtn.style.opacity = "0.5";
                    bannerBtn.style.cursor = "not-allowed";
                }

                if (data.discordDecoration) {
                    decoBtn.disabled = false;
                    decoBtn.style.opacity = "1";
                    decoBtn.style.filter = "none";
                    if (data.decoration) {
                        decoBtn.style.background = "rgba(56, 189, 248, 0.2)";
                        decoBtn.style.color = "var(--accent-color)";
                        decoBtn.style.border = "1px solid var(--accent-color)";
                        decoBtn.textContent = "Quitar Decoración";
                    } else {
                        decoBtn.style.background = "var(--accent-color)";
                        decoBtn.style.color = "var(--primary-bg)";
                        decoBtn.style.border = "none";
                        decoBtn.textContent = "Usar Decoración";
                    }
                } else {
                    decoBtn.disabled = true;
                    decoBtn.style.opacity = "0.5";
                    decoBtn.style.filter = "grayscale(1)";
                    decoBtn.textContent = "Sin Decoración";
                }

                if (data.discordBanner) {
                    bannerBtn.disabled = false;
                    bannerBtn.style.opacity = "1";
                    bannerBtn.style.filter = "none";
                    bannerBtn.style.background = "var(--accent-color)";
                    bannerBtn.style.color = "var(--primary-bg)";
                } else {
                    bannerBtn.disabled = true;
                    bannerBtn.style.opacity = "0.5";
                    bannerBtn.style.filter = "grayscale(1)";
                }
            } else {
                status.innerHTML = '<span style="color:var(--text-dim);">No vinculado</span>';
                actions.style.display = 'block';
                linked.style.display = 'none';
            }
        }

        function closeEditModal() { document.getElementById('editProfileModal').classList.remove('active'); }

        async function saveProfile() {
            if (!currentUser) return;
            const avatar = document.getElementById('editAvatar').value.trim();
            const banner = document.getElementById('editBanner').value.trim();
            const bio = document.getElementById('editBio').value.trim();
            const currentDeco = document.getElementById('editProfileModal').dataset.tempDeco || null;

            try {
                // El campo 'decoration' es el aplicado, 'discordDecoration' es el origen.
                await database.ref('fenixstore/social/users/' + currentUser.username).update({
                    avatar,
                    banner,
                    bio,
                    decoration: currentDeco
                });
                showAlert("Perfil actualizado");
                closeEditModal();
                viewProfile(currentUser.username);
                updateSidebar(currentUser.username);
            } catch (e) { showAlert("Error: " + e.message); }
        }

        async function generateLinkToken() {
            if (!currentUser) return;
            const token = Math.random().toString(36).substring(2, 8).toUpperCase();
            const expires = Date.now() + (5 * 60 * 1000); // 5 mins

            try {
                await database.ref('fenixstore/social/link_tokens/' + token).set({
                    username: currentUser.username,
                    expires: expires
                });

                document.getElementById('discordActions').style.display = 'none';
                document.getElementById('discordTokenDisplay').style.display = 'block';
                document.getElementById('discordTokenCode').textContent = `%vincular ${token}`;

                // Listen for successful link (the bot will remove the token and update user data)
                const discordListener = database.ref('fenixstore/social/users/' + currentUser.username + '/discordId');
                discordListener.on('value', async (snap) => {
                    if (snap.exists()) {
                        // Otorgar sticker Facha al vincular Discord
                        const userRef = database.ref('fenixstore/social/users/' + currentUser.username);
                        const userData = (await userRef.once('value')).val() || {};
                        const currentStickers = userData.unlockedStickers || [];

                        if (!currentStickers.includes('assets/facha.webp')) {
                            currentStickers.push('assets/facha.webp');
                            await userRef.update({ unlockedStickers: currentStickers });

                            // Actualizar inmediatamente la variable local para el selector de emojis
                            if (!userUnlockedStickers.includes('assets/facha.webp')) {
                                userUnlockedStickers.push('assets/facha.webp');
                            }
                        }

                        showAlert("¡Discord vinculado exitosamente! Desbloqueaste el sticker Facha");
                        discordListener.off(); // Detener el listener
                        openEditModal(); // Refresh the modal state
                    }
                });
            } catch (e) { showAlert("Error al generar token"); }
        }

        async function useDiscordAvatar() {
            if (!currentUser) return;
            const snap = await database.ref('fenixstore/social/users/' + currentUser.username).once('value');
            const data = snap.val();
            if (data && data.discordAvatar) {
                document.getElementById('editAvatar').value = data.discordAvatar;
                showAlert("Añadida foto de Discord. Dale a Guardar.");
            }
        }

        async function useDiscordName() {
            // Since we use the store username as key, "using discord name" 
            // might just mean updating the bio or a future 'displayName' field.
            // For now, let's just show an alert or set it in bio.
            if (!currentUser) return;
            const snap = await database.ref('fenixstore/social/users/' + currentUser.username).once('value');
            const data = snap.val();
            if (data && data.discordUsername) {
                document.getElementById('editBio').value = "Soy " + data.discordUsername + " en Discord. " + document.getElementById('editBio').value;
                showAlert("Nombre de Discord añadido a tu bio.");
            }
        }

        async function useDiscordBanner() {
            if (!currentUser) return;
            const snap = await database.ref('fenixstore/social/users/' + currentUser.username).once('value');
            const data = snap.val();
            if (data && data.discordBanner) {
                document.getElementById('editBanner').value = data.discordBanner;
                showAlert("Banner de Discord aplicado. Dale a Guardar.");
            } else {
                showAlert("Tu cuenta de Discord no tiene un banner público.");
            }
        }

        async function toggleDecoration() {
            if (!currentUser) return;
            const modal = document.getElementById('editProfileModal');
            const decoBtn = document.getElementById('toggleDecoBtn');
            const snap = await database.ref('fenixstore/social/users/' + currentUser.username).once('value');
            const data = snap.val();

            if (!data || !data.discordDecoration) {
                return showAlert("No tienes una decoración de Discord para usar.");
            }

            // Toggle logic using dataset
            if (modal.dataset.tempDeco) {
                delete modal.dataset.tempDeco;
                decoBtn.style.background = "var(--accent-color)";
                decoBtn.style.color = "var(--primary-bg)";
                decoBtn.style.border = "none";
                decoBtn.textContent = "Usar Decoración";
                showAlert("Decoración desactivada. Dale a Guardar.");
            } else {
                modal.dataset.tempDeco = data.discordDecoration;
                decoBtn.style.background = "rgba(56, 189, 248, 0.2)";
                decoBtn.style.color = "var(--accent-color)";
                decoBtn.style.border = "1px solid var(--accent-color)";
                decoBtn.textContent = "Quitar Decoración";
                showAlert("Decoración de Discord activada. Dale a Guardar.");
            }
        }

        async function unlinkDiscord() {
            if (!currentUser || !confirm("¿Estás seguro de que quieres desvincular tu cuenta de Discord?")) return;
            try {
                await database.ref('fenixstore/social/users/' + currentUser.username).update({
                    discordId: null,
                    discordUsername: null,
                    discordAvatar: null,
                    discordBanner: null,
                    discordDecoration: null
                });
                delete document.getElementById('editProfileModal').dataset.tempDeco;
                showAlert("Discord desvinculado");
                openEditModal(); // Refresh modal
                viewProfile(currentUser.username); // Refresh profile view
            } catch (e) { showAlert("Error: " + e.message); }
        }

        async function likePost(id) {
            if (!currentUser) return document.getElementById('authModal').classList.add('active');

            const postRef = database.ref('fenixstore/social/posts/' + id);
            try {
                const result = await postRef.transaction(post => {
                    if (post) {
                        post.likedBy = post.likedBy || {};
                        if (post.likedBy[currentUser.username]) {
                            post.likes = Math.max(0, (post.likes || 1) - 1);
                            delete post.likedBy[currentUser.username];
                        } else {
                            post.likes = (post.likes || 0) + 1;
                            post.likedBy[currentUser.username] = true;
                        }
                    }
                    return post;
                });

                // Actualizar UI localmente de forma inmediata
                const btn = document.querySelector(`[onclick="likePost('${id}')"]`);
                if (btn && result.snapshot) {
                    const data = result.snapshot.val();
                    const icon = btn.querySelector('i');
                    const countSpan = btn.querySelector('span');
                    const isLiked = data.likedBy && data.likedBy[currentUser.username];

                    btn.classList.toggle('active', isLiked);
                    icon.className = isLiked ? 'fas fa-heart' : 'far fa-heart';
                    countSpan.textContent = data.likes || 0;

                    if (isLiked) {
                        btn.style.color = 'var(--danger)';
                        icon.style.transform = 'scale(1.2)';
                        setTimeout(() => icon.style.transform = 'scale(1)', 200);
                    } else {
                        btn.style.color = 'var(--text-dim)';
                    }
                }
            } catch (e) {
                console.error("Error al dar like:", e);
                showAlert("Error al procesar like");
            }
        }

        let activeCommentPostId = null;
        async function openComments(postId) {
            activeCommentPostId = postId;
            const modal = document.getElementById('commentModal');
            const list = document.getElementById('commentsList');
            modal.classList.add('active');
            list.innerHTML = '<p style="text-align:center; color:var(--text-dim); padding:1rem;">Cargando comentarios...</p>';

            database.ref(`fenixstore/social/posts/${postId}/comments`).on('value', async (snap) => {
                if (activeCommentPostId !== postId) return;
                list.innerHTML = '';
                const comments = [];
                snap.forEach(child => {
                    comments.unshift({ id: child.key, ...child.val() });
                });

                if (comments.length === 0) {
                    list.innerHTML = '<p style="text-align:center; color:var(--text-dim); padding:2rem;">No hay comentarios aún. ¡Sé el primero!</p>';
                    return;
                }

                for (const c of comments) {
                    const cDiv = document.createElement('div');
                    cDiv.className = 'comment-item';

                    const userSnap = await database.ref('fenixstore/social/users/' + c.author).once('value');
                    const uData = userSnap.val() || {};
                    const initials = c.author.charAt(0).toUpperCase();
                    let avatarHtml = uData.avatar ? `<img src="${uData.avatar}">` : initials;
                    if (uData.decoration) avatarHtml += `<img src="${uData.decoration}" class="avatar-decoration" style="width:130% !important; height:130% !important;">`;

                    cDiv.innerHTML = `
                        <div class="comment-avatar">${avatarHtml}</div>
                        <div class="comment-body">
                            <div class="comment-author" onclick="closeCommentModal(); viewProfile('${c.author}')">${c.author}</div>
                            <div class="comment-text">${parseContent(c.text)}</div>
                            <div class="comment-time">${new Date(c.timestamp).toLocaleString([], { hour: '2-digit', minute: '2-digit', day: '2-digit', month: '2-digit' })}</div>
                        </div>
                    `;
                    list.appendChild(cDiv);
                }
            });
        }

        function closeCommentModal() {
            if (activeCommentPostId) {
                database.ref(`fenixstore/social/posts/${activeCommentPostId}/comments`).off();
            }
            document.getElementById('commentModal').classList.remove('active');
            document.getElementById('commentInput').value = '';
            activeCommentPostId = null;
        }

        document.getElementById('submitCommentBtn').onclick = async () => {
            if (!currentUser) return document.getElementById('authModal').classList.add('active');
            const editor = document.getElementById('commentInput');
            const text = parseEditorContent(editor);
            if (!text || !activeCommentPostId) return;

            const btn = document.getElementById('submitCommentBtn');
            btn.disabled = true;
            btn.textContent = 'Enviando...';

            try {
                const commentData = {
                    author: currentUser.username,
                    text: text,
                    timestamp: Date.now()
                };

                await database.ref(`fenixstore/social/posts/${activeCommentPostId}/comments`).push(commentData);

                await database.ref(`fenixstore/social/posts/${activeCommentPostId}`).transaction(post => {
                    if (post) {
                        post.commentsCount = (post.commentsCount || 0) + 1;
                    }
                    return post;
                });

                editor.innerHTML = '';
            } catch (e) {
                showAlert("Error: " + e.message);
            } finally {
                btn.disabled = false;
                btn.textContent = 'Publicar Comentario';
            }
        };

        function showAlert(m) {
            const a = document.createElement('div'); a.className = 'fenix-alert'; a.textContent = m;
            document.body.appendChild(a); setTimeout(() => a.remove(), 3000);
        }

        function escapeHtml(t) { const d = document.createElement('div'); d.textContent = t; return d.innerHTML; }

        function highlightHashtags(text) {
            return text.replace(/#[a-zA-Z0-9_áéíóúñÁÉÍÓÚÑ]+/g, (match) => {
                return `<span style="color: var(--accent-color); font-weight: 600; cursor: pointer;" onclick="filterFeedByTag('${match}')">${match}</span>`;
            });
        }

        function parseContent(text) {
            let parsed = escapeHtml(text);

            // Reemplazar códigos de stickers: [STK:assets/name.webp]
            parsed = parsed.replace(/\[STK:(.+?)\]/g, (match, url) => {
                return `<img src="${url}" class="post-sticker" style="width: 38px; height: 38px; vertical-align: middle; margin: 2px; object-fit: contain;">`;
            });

            return highlightHashtags(parsed);
        }

        document.getElementById('logoutBtn').addEventListener('click', () => {
            localStorage.removeItem('fenixStoreUser');
            sessionStorage.removeItem('fenixStoreUser');
            window.location.href = 'index.html';
        });

        document.getElementById('profileLink').addEventListener('click', (e) => {
            e.preventDefault();
            if (currentUser) viewProfile(currentUser.username);
            else document.getElementById('authModal').classList.add('active');
        });

        // Auth Helpers
        function showAuthError(message) {
            const errorDiv = document.getElementById('authError');
            errorDiv.textContent = message;
            errorDiv.style.display = 'block';
            setTimeout(() => { errorDiv.style.display = 'none'; }, 5000);
        }
        function showAuthSuccess(message) {
            const successDiv = document.getElementById('authSuccess');
            successDiv.textContent = message;
            successDiv.style.display = 'block';
            setTimeout(() => { successDiv.style.display = 'none'; }, 5000);
        }
        function clearAuthForms() {
            document.getElementById('loginForm').reset();
            document.getElementById('registerForm').reset();
            document.getElementById('authError').style.display = 'none';
            document.getElementById('authSuccess').style.display = 'none';
        }
        function hashPassword(password) {
            let hash = 0;
            for (let i = 0; i < password.length; i++) {
                const char = password.charCodeAt(i);
                hash = ((hash << 5) - hash) + char;
                hash = hash & hash;
            }
            return hash.toString();
        }

        // Modal Controls
        document.getElementById('loginBtnNav').addEventListener('click', () => {
            document.getElementById('authModal').classList.add('active');
        });
        document.getElementById('closeAuthModal').addEventListener('click', () => {
            document.getElementById('authModal').classList.remove('active');
            clearAuthForms();
        });
        document.getElementById('closeAuthModalX').addEventListener('click', () => {
            document.getElementById('authModal').classList.remove('active');
            clearAuthForms();
        });

        let isLoginMode = true;
        function toggleAuthMode() {
            isLoginMode = !isLoginMode;
            const authTitle = document.getElementById('authTitle');
            const loginForm = document.getElementById('loginForm');
            const registerForm = document.getElementById('registerForm');
            const toggleText = document.getElementById('toggleText');

            if (isLoginMode) {
                authTitle.textContent = 'Iniciar Sesión';
                loginForm.style.display = 'block';
                registerForm.style.display = 'none';
                toggleText.innerHTML = '¿No tienes cuenta? <a id="toggleAuthForm">Regístrate aquí</a>';
            } else {
                authTitle.textContent = 'Registrarse';
                loginForm.style.display = 'none';
                registerForm.style.display = 'block';
                toggleText.innerHTML = '¿Ya tienes cuenta? <a id="toggleAuthForm">Inicia sesión aquí</a>';
            }
            // Re-vincular porque el innerHTML borra el anterior
            document.getElementById('toggleAuthForm').addEventListener('click', toggleAuthMode);
        }
        document.getElementById('toggleAuthForm').addEventListener('click', toggleAuthMode);

        // Form Submissions
        document.getElementById('loginForm').addEventListener('submit', async (e) => {
            e.preventDefault();
            const username = document.getElementById('loginUsername').value.trim();
            const password = document.getElementById('loginPassword').value;

            if (!username || !password) return showAuthError('Completa todos los campos');

            try {
                const snap = await database.ref('fenixstore/users/' + username).once('value');
                if (!snap.exists()) return showAuthError('Usuario no encontrado');

                const userData = snap.val();
                if (userData.password !== hashPassword(password)) return showAuthError('Contraseña incorrecta');

                currentUser = { username: userData.username, createdAt: userData.createdAt };
                const remember = document.getElementById('rememberLogin').checked;
                if (remember) localStorage.setItem('fenixStoreUser', JSON.stringify(currentUser));
                else sessionStorage.setItem('fenixStoreUser', JSON.stringify(currentUser));

                showAuthSuccess('¡Bienvenido!');
                setTimeout(() => {
                    document.getElementById('authModal').classList.remove('active');
                    location.reload(); // Refresh to update all UI
                }, 1500);
            } catch (err) { showAuthError('Error: ' + err.message); }
        });

        document.getElementById('registerForm').addEventListener('submit', async (e) => {
            e.preventDefault();
            const username = document.getElementById('registerName').value.trim();
            const password = document.getElementById('registerPassword').value;
            const passwordConfirm = document.getElementById('registerPasswordConfirm').value;

            if (username.length < 3 || username.length > 20) return showAuthError('Nombre entre 3 y 20 caracteres');
            if (password !== passwordConfirm) return showAuthError('Las contraseñas no coinciden');
            if (password.length < 6) return showAuthError('Mínimo 6 caracteres en la clave');

            try {
                const snap = await database.ref('fenixstore/users/' + username).once('value');
                if (snap.exists()) return showAuthError('El usuario ya existe');

                await database.ref('fenixstore/users/' + username).set({
                    username, password: hashPassword(password), createdAt: new Date().toISOString()
                });

                // Crear perfil social con sticker de bienvenida
                await database.ref('fenixstore/social/users/' + username).set({
                    unlockedStickers: ['assets/fenix.png'],
                    joinedDate: new Date().toISOString()
                });

                currentUser = { username, createdAt: new Date().toISOString() };
                localStorage.setItem('fenixStoreUser', JSON.stringify(currentUser));

                showAuthSuccess('¡Registro exitoso!');
                setTimeout(() => {
                    document.getElementById('authModal').classList.remove('active');
                    location.reload();
                }, 1500);
            } catch (err) { showAuthError('Error: ' + err.message); }
        });

        function deletePost(id) {
            if (confirm("¿Estás seguro de que quieres borrar esta publicación?")) {
                database.ref('fenixstore/social/posts/' + id).remove()
                    .then(() => {
                        showAlert("Publicación borrada");
                        if (!document.getElementById('profileView').classList.contains('hidden')) {
                            viewProfile(currentUser.username);
                        } else {
                            loadFeed();
                        }
                    })
                    .catch(e => showAlert("Error: " + e.message));
            }
        }

        const emojis = ["😀", "😂", "🥰", "😍", "😎", "🤔", "🔥", "✨", "🙌", "💀", "😭", "🚀", "🎮", "❤️", "👍", "👀", "💯", "🎉"];
        let userUnlockedStickers = [];

        function toggleEmojiPicker() {
            const picker = document.getElementById('emojiPicker');
            picker.classList.toggle('active');

            // Re-renderizar siempre o al menos cuando se abre para asegurar que los stickers estén actualizados
            let html = emojis.map(e => `<span class="emoji-btn" onclick="insertEmoji('${e}')">${e}</span>`).join('');

            if (userUnlockedStickers.length > 0) {
                html += '<div style="grid-column: 1/-1; padding-top: 5px; margin-top: 5px; border-top: 1px solid #333; font-size: 0.7rem; color: var(--text-dim); text-align: left;">Tus Stickers</div>';
                userUnlockedStickers.forEach(stk => {
                    if (stk !== 'none') {
                        html += `<span class="emoji-btn" onclick="insertSticker('${stk}')" title="${stk}"><img src="${stk}"></span>`;
                    }
                });
            }

            picker.innerHTML = html;
        }

        function toggleEmojiPickerGroup() {
            const picker = document.getElementById('emojiPickerGroup');
            if (!picker) {
                console.error('emojiPickerGroup no encontrado');
                return;
            }

            picker.classList.toggle('active');

            // Solo renderizar cuando se abre
            if (picker.classList.contains('active')) {
                // Re-renderizar siempre o al menos cuando se abre para asegurar que los stickers estén actualizados
                let html = emojis.map(e => `<span class="emoji-btn" onclick="insertEmojiGroup('${e}')">${e}</span>`).join('');

                if (userUnlockedStickers.length > 0) {
                    html += '<div style="grid-column: 1/-1; padding-top: 5px; margin-top: 5px; border-top: 1px solid #333; font-size: 0.7rem; color: var(--text-dim); text-align: left;">Tus Stickers</div>';
                    userUnlockedStickers.forEach(stk => {
                        if (stk !== 'none') {
                            html += `<span class="emoji-btn" onclick="insertStickerGroup('${stk}')" title="${stk}"><img src="${stk}"></span>`;
                        }
                    });
                }

                picker.innerHTML = html;
            }
        }

        function insertEmoji(e) {
            const input = document.getElementById('postContent');
            const commentInput = document.getElementById('commentInput');
            const isComment = document.getElementById('commentModal').classList.contains('active');
            const targetInput = isComment ? commentInput : input;

            targetInput.focus();
            document.execCommand('insertHTML', false, e);

            if (targetInput === input) {
                document.getElementById('publishBtn').disabled = false;
            }
            document.getElementById('emojiPicker').classList.remove('active');
        }

        function insertSticker(url) {
            const input = document.getElementById('postContent');
            const commentInput = document.getElementById('commentInput');
            const isComment = document.getElementById('commentModal').classList.contains('active');
            const targetInput = isComment ? commentInput : input;

            const stickerHtml = `<img src="${url}" class="editor-sticker" alt="sticker">`;

            targetInput.focus();
            document.execCommand('insertHTML', false, stickerHtml);

            if (targetInput === input) {
                document.getElementById('publishBtn').disabled = false;
            }
            document.getElementById('emojiPicker').classList.remove('active');
        }

        function insertEmojiGroup(e) {
            const input = document.getElementById('groupMessageInput');
            input.focus();
            document.execCommand('insertHTML', false, e);
            document.getElementById('emojiPickerGroup').classList.remove('active');
        }

        function insertStickerGroup(url) {
            const input = document.getElementById('groupMessageInput');
            const stickerHtml = `<img src="${url}" class="editor-sticker" alt="sticker">`;
            input.focus();
            document.execCommand('insertHTML', false, stickerHtml);
            document.getElementById('emojiPickerGroup').classList.remove('active');
        }

        // Cerrar picker al hacer clic fuera
        document.addEventListener('click', (e) => {
            // No cerrar si se hace clic en los botones de herramientas o en el picker mismo
            if (!e.target.closest('.post-tools') && !e.target.closest('.chat-input-wrapper') && !e.target.closest('.emoji-picker')) {
                document.getElementById('emojiPicker').classList.remove('active');
                const groupPicker = document.getElementById('emojiPickerGroup');
                if (groupPicker) groupPicker.classList.remove('active');
            }

            // Cerrar modals al hacer clic en el overlay
            if (e.target.classList.contains('modal-overlay')) {
                e.target.classList.remove('active');
                if (e.target.id === 'authModal') clearAuthForms();
            }
        });

        checkSession();
        loadFeed();
        loadTrending();

        function openGameSelector() {
            document.getElementById('gameSelectorModal').classList.add('active');
        }
    </script>

    <!-- Game Selection Modal (Arcade) -->
    <div class="modal-overlay" id="gameSelectorModal">
        <div class="modal-content"
            style="text-align: center; max-width: 600px; background: #0f172a; border: 1px solid rgba(255,255,255,0.1);">
            <div class="modal-close-btn"
                onclick="document.getElementById('gameSelectorModal').classList.remove('active')">×</div>
            <h2 style="font-size: 2rem; margin-bottom: 10px;">Comu Arcade</h2>
            <p style="color: rgba(255,255,255,0.7); margin-bottom: 30px; font-size: 1.1rem;">Selecciona tu desafío</p>

            <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 20px;">
                <div onclick="window.location.href='comu-invaders.html'"
                    style="background: linear-gradient(135deg, #ef4444, #7f1d1d); padding: 20px; border-radius: 20px; cursor: pointer; transition: all 0.3s; position: relative; overflow: hidden; border: 2px solid rgba(255,255,255,0.1);">
                    <div
                        style="position: absolute; top: 0; left: 0; width: 100%; height: 100%; background: radial-gradient(circle at top right, rgba(255,255,255,0.1), transparent); pointer-events: none;">
                    </div>
                    <img src="assets/Comulien.webp"
                        style="width: 70px; height: 70px; object-fit: contain; margin-bottom: 15px; filter: drop-shadow(0 5px 5px rgba(0,0,0,0.3));">
                    <h3 style="margin: 0; font-size: 1.2rem; color: white;">Comu Invaders</h3>
                    <p style="font-size: 0.8rem; opacity: 0.9; margin-top: 5px; color: #fecaca;">Shooter Arcade</p>
                </div>

                <div onclick="window.location.href='comu-monsters.html'"
                    style="background: linear-gradient(135deg, #3b82f6, #1e3a8a); padding: 20px; border-radius: 20px; cursor: pointer; transition: all 0.3s; position: relative; overflow: hidden; border: 2px solid rgba(255,255,255,0.1);">
                    <div
                        style="position: absolute; top: 0; left: 0; width: 100%; height: 100%; background: radial-gradient(circle at top right, rgba(255,255,255,0.1), transparent); pointer-events: none;">
                    </div>
                    <img src="assets/Comu.webp"
                        style="width: 70px; height: 70px; object-fit: contain; margin-bottom: 15px; filter: drop-shadow(0 5px 5px rgba(0,0,0,0.3));">
                    <h3 style="margin: 0; font-size: 1.2rem; color: white;">Comu Monsters</h3>
                    <p style="font-size: 0.8rem; opacity: 0.9; margin-top: 5px; color: #bfdbfe;">RPG / PvP</p>
                </div>
            </div>

            <style>
                #gameSelectorModal div[onclick]:hover {
                    transform: translateY(-5px);
                    box-shadow: 0 10px 20px rgba(0, 0, 0, 0.4);
                    border-color: rgba(255, 255, 255, 0.3);
                }

                #gameSelectorModal div[onclick]:active {
                    transform: scale(0.98);
                }
            </style>
        </div>
    </div>
</body>

</html>